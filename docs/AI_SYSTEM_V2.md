# AI System v2.0 - –£–ª—É—á—à–µ–Ω–∏—è –∏ –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–í–µ—Ä—Å–∏—è 2.0 AI-—Å–∏—Å—Ç–µ–º—ã –ï–≤–≥–µ–Ω–∏—á–∞ –≤–∫–ª—é—á–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤.

## üéØ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. ‚ö° Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è OpenAI API (`ai/retry_handler.py`)

**–ü—Ä–æ–±–ª–µ–º–∞:** API –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω rate limit
**–†–µ—à–µ–Ω–∏–µ:** Exponential backoff —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ rate limit errors
- Exponential backoff (1s ‚Üí 2s ‚Üí 4s)
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from ai.retry_handler import retry_with_backoff

result = retry_with_backoff(
    func=lambda: api_call(),
    max_retries=3,
    fallback_response="–í—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
)
```

---

### 2. üóÑÔ∏è –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (`ai/knowledge_cache.py`)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ (–º–µ–¥–ª–µ–Ω–Ω–æ)
**–†–µ—à–µ–Ω–∏–µ:** –ö–µ—à —Å TTL (time-to-live)

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (TTL: 5 –º–∏–Ω—É—Ç)
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (TTL: 3 –º–∏–Ω—É—Ç—ã)
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –±–∞—Ä–∞ (TTL: 10 –º–∏–Ω—É—Ç)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏

**–ü—Ä–∏–º–µ—Ä:**
```python
from ai.knowledge_cache import cached_knowledge_base

kb = cached_knowledge_base()  # –ë—ã—Å—Ç—Ä–æ!
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞:**
```python
from ai.knowledge_cache import get_cache_stats

stats = get_cache_stats()
# {
#   "knowledge_base": {"total_entries": 1, "active_entries": 1},
#   "user_data": {"total_entries": 150, "active_entries": 142},
#   ...
# }
```

---

### 3. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ AI (`ai/response_validator.py`)

**–ü—Ä–æ–±–ª–µ–º–∞:** AI –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π/–æ–ø–∞—Å–Ω—ã–π –æ—Ç–≤–µ—Ç
**–†–µ—à–µ–Ω–∏–µ:** –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- –ü—É—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ —Ç–µ–∫—Å—Ç–µ (error, exception, null)
- –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–¥ (```python, <script>, eval())
- –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ñ—Ä–∞–∑—ã (–∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ AI)
- –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–æ–±—Ä–µ–∑–∫–∞)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ (—Å–º–∞–π–ª–∏–∫–∏, –¥–ª–∏–Ω–∞, –∏ —Ç.–¥.)

**–ü—Ä–∏–º–µ—Ä:**
```python
from ai.response_validator import validate_ai_response

is_valid, clean_response = validate_ai_response(raw_response)
if is_valid:
    return clean_response
else:
    return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫"
```

**–ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞:**
```python
from ai.response_validator import check_response_quality

metrics = check_response_quality(response)
# {
#   "length": 120,
#   "word_count": 18,
#   "has_emoji": True,
#   "quality_score": 85
# }
```

---

### 4. üí¨ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ (`ai/conversation_context.py`)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –Ω–µ –ø–æ–º–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –•—Ä–∞–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ø–∞—Ä user/assistant —Å–æ–æ–±—â–µ–Ω–∏–π
- TTL: 30 –º–∏–Ω—É—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤)
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```python
from ai.conversation_context import conversation_context

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ assistant.py:
# 1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# 2. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ messages –¥–ª—è OpenAI
# 3. –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ
```

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
context = conversation_context.get_context(user_id)

# –û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
conversation_context.clear_context(user_id)

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
stats = conversation_context.get_stats()
# {
#   "total_users": 523,
#   "active_contexts": 87,
#   "total_messages": 912,
#   "avg_messages_per_user": 10.5
# }
```

---

### 5. üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∑–∞—Ç—Ä–∞—Ç (`ai/metrics.py`)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ OpenAI API
**–†–µ—à–µ–Ω–∏–µ:** –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ (input + output)
- –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –≤ USD
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
- –ú–æ–¥–µ–ª—å (gpt-4o, gpt-3.5-turbo, –∏ —Ç.–¥.)

**–§–æ—Ä–º–∞—Ç –ª–æ–≥–∞ (JSONL):**
```json
{
  "timestamp": "2026-01-05T14:23:45",
  "user_id": 123456,
  "model": "gpt-4o",
  "prompt_tokens": 450,
  "completion_tokens": 85,
  "total_tokens": 535,
  "response_time_ms": 1234.56,
  "cost_usd": 0.001735,
  "success": true
}
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
```python
from ai.metrics import ai_metrics

# –ó–∞ —Å–µ–≥–æ–¥–Ω—è
daily = ai_metrics.get_daily_stats()
# {
#   "date": "2026-01-05",
#   "total_requests": 1523,
#   "successful_requests": 1498,
#   "failed_requests": 25,
#   "total_tokens": 234567,
#   "total_cost_usd": 12.3456,
#   "avg_response_time_ms": 987.65,
#   "unique_users": 287
# }

# –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_stats = ai_metrics.get_user_stats(user_id, days=7)
# {
#   "user_id": 123456,
#   "period_days": 7,
#   "total_requests": 45,
#   "total_tokens": 5234,
#   "total_cost_usd": 0.0523
# }
```

---

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ `get_ai_recommendation()`

```python
response = get_ai_recommendation(
    user_query="–ö–∞–∫ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–∏–∫?",
    user_id=123456,  # ‚Üê –ù–û–í–û–ï! –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –º–µ—Ç—Ä–∏–∫
    conversation_history=None,  # –¢–µ–ø–µ—Ä—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (—É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
    daily_updates={"special": "–•—É–±–∞-–ë—É–±–∞ -20%"},
    user_concept="evgenich",
    user_type="regular",
    bar_context="–°–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç, –º–Ω–æ–≥–æ –≥–æ—Å—Ç–µ–π",
    emotion={"emotion": "joy", "intensity": 0.8},
    preferences="–õ—é–±–∏—Ç –Ω–∞—Å—Ç–æ–π–∫–∏",
    is_group_chat=False,
    model="gpt-4o",
    temperature=0.9,
    max_tokens=120
)
```

---

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –î–æ —É–ª—É—á—à–µ–Ω–∏–π:
- ‚ùå –ü–∞–¥–µ–Ω–∏–µ –ø—Ä–∏ rate limit
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
- ‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–æ—Ö–æ–¥–∏–ª–∏
- ‚ùå –ë–æ—Ç –Ω–µ –ø–æ–º–Ω–∏–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç
- ‚ùå –ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è –∑–∞—Ç—Ä–∞—Ç

### –ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –±—ã—Å—Ç—Ä–µ–µ –≤ 3-5 —Ä–∞–∑
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç ‚Üí –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ ‚Üí –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –∑–∞—Ç—Ä–∞—Ç

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

1. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤** - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫
2. **–î–µ—Ç–µ–∫—Ç–æ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏–π** - –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
3. **Fallback –æ—Ç–≤–µ—Ç—ã** - –ø—Ä–æ—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã –±–µ–∑ AI –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏:
- **AI –º–µ—Ç—Ä–∏–∫–∏:** `logs/ai_metrics.jsonl`
- **–ù–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:** `ai_failed_queries.log`
- **–û—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏:** –ß–µ—Ä–µ–∑ `logging.getLogger("evgenich_ai")`

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```python
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞
from ai.knowledge_cache import get_cache_stats
print(get_cache_stats())

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
from ai.conversation_context import conversation_context
print(conversation_context.get_stats())

# –ú–µ—Ç—Ä–∏–∫–∏ AI
from ai.metrics import ai_metrics
print(ai_metrics.get_daily_stats())
```

---

## üìù Changelog

### v2.0 (2026-01-05)
- ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∞ retry –ª–æ–≥–∏–∫–∞ –¥–ª—è OpenAI API
- ‚ûï –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∏ –¥–∞–Ω–Ω—ã—Ö
- ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤
- ‚ûï –°–æ–∑–¥–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
- ‚ûï –î–æ–±–∞–≤–ª–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∑–∞—Ç—Ä–∞—Ç
- üîß –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `assistant.py` –∏ `ai_logic.py`

### v1.0
- –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI
- –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
- –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π

---

## üë• –ö–æ–º–∞–Ω–¥–∞

–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è –±–∞—Ä–∞ "–ï–≤–≥–µ–Ω–∏—á" —Å –ª—é–±–æ–≤—å—é ü•É
