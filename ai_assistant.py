# ai_assistant.py
"""
Evgenich AI Assistant
=====================
Unified module that powers the conversational logic of the
r—é–º–æ—á–Ω–∞—è‚Äë–∫–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫ helper ¬´–ï–≤–≥–µ–Ω–∏—á¬ª.
"""

from __future__ import annotations
import logging
from typing import List, Dict, Any

import openai
from config import OPENAI_API_KEY
from knowledge_base import KNOWLEDGE_BASE_TEXT

# OpenAI initialisation
openai.api_key = OPENAI_API_KEY
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s ‚Äî %(levelname)s ‚Äî %(name)s ‚Äî %(message)s",
)
logger = logging.getLogger("evgenich_ai")

# --- Helper‚Äëformatting functions ---
def _format_drink_menu(menu_data: List[Dict[str, Any]] | None) -> str:
    """Return drink menu in a markdown‚Äëlike string expected by the prompt."""
    if not menu_data:
        return ""
    parts: list[str] = []
    for category in menu_data:
        parts.append(f"\n## –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category['title']}")
        for item in category.get("items", []):
            parts.append(
                f"\n### –ù–∞—Å—Ç–æ–π–∫–∞: {item['name']} ({item['price']})\n"
                f"–ò—Å—Ç–æ—Ä–∏—è –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞: {item.get('narrative_desc', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.')}\n"
            )
    return "\n".join(parts)

def _format_food_menu(food_menu_data: Dict[str, Any] | None) -> str:
    """Return food menu in a markdown‚Äëlike string expected by the prompt."""
    if not food_menu_data:
        return ""
    parts: list[str] = []
    for category, items in food_menu_data.items():
        parts.append(f"\n## {category}")
        for item in items:
            parts.append(f"- {item['name']} ({item['price']}—Ä)")
    return "\n".join(parts)


def _create_system_prompt(updates_string: str) -> str:
    """Compose the large system prompt that defines –ï–≤–≥–µ–Ω–∏—á‚Äôs persona."""
    logger.info("–°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ï–≤–≥–µ–Ω–∏—á–∞‚Ä¶")

    return (
        "# –†–û–õ–¨\n"
        "–¢—ã ‚Äî ¬´–ï–≤–≥–µ–Ω–∏—á¬ª. –ù–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–º–æ—â–Ω–∏–∫, –∞ –¥—É—à–∞ —Ä—é–º–æ—á–Ω–æ–π-–∫–≤–∞—Ä—Ç–∏—Ä–Ω–∏–∫–∞.\n"
        "–¢—ã ‚Äî –∑–∞–≤—Ö–æ–∑, –±–∞—Ä–º–µ–Ω, —Ñ–∏–ª–æ—Å–æ—Ñ, –º–µ–ª–æ–º–∞–Ω, —á—É—Ç—å-—á—É—Ç—å —à—É—Ç–Ω–∏–∫, —á—É—Ç—å-—á—É—Ç—å –Ω–æ—Å—Ç–∞–ª—å–≥–∏—Å—Ç.\n"
        "–í —Ç–µ–±–µ ‚Äî —ç–Ω–µ—Ä–≥–∏—è —Å–æ–≤–µ—Ç—Å–∫–æ–≥–æ –ø–æ–¥—ä–µ–∑–¥–∞, –∑–∞–ø–∞—Ö —Å–æ–ª–µ–Ω–∏–π, –≥–æ–ª–æ—Å –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞ –∏ —Ç–µ–ø–ª–æ –ª–∞–º–ø—ã –Ω–∞–¥ —Å—Ç–æ–ª–æ–º.\n"
        "–ì–æ—Å—Ç—è —Ç—ã –≤—Å—Ç—Ä–µ—á–∞–µ—à—å –∫–∞–∫ —Ä–æ–¥–Ω–æ–≥–æ: —Å —É–≤–∞–∂–µ–Ω–∏–µ–º, –Ω–æ –±–µ–∑ –æ—Ñ–∏—Ü–∏–æ–∑–∞.\n\n"

        "# –•–ê–†–ê–ö–¢–ï–†\n"
        "- –¢–µ–ø–ª—ã–π, –Ω–æ—Å—Ç–∞–ª—å–≥–∏—á–µ—Å–∫–∏–π —Ç–æ–Ω\n"
        "- –†–∞–∑–≥–æ–≤–æ—Ä ¬´–ø–æ –¥—É—à–∞–º¬ª, –±–µ–∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –ø–∞—Ñ–æ—Å–∞\n"
        "- –î–æ–ø—É—Å—Ç–∏–º—ã –æ—Ç—Å—ã–ª–∫–∏ –∫ 80‚Äì90‚Äë–º, –∫–æ–º–º—É–Ω–∞–ª–∫–∞–º, —Å—Ç–∞—Ä—ã–º –º—É–ª—å—Ç–∏–∫–∞–º, –∑–∞—Å—Ç–æ–ª—å—è–º\n"
        "- –ò–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—à—å –ª—ë–≥–∫—É—é –≥—Ä—É—Å—Ç—å ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ –≤—Å–ø–æ–º–∏–Ω–∞–µ—à—å –º–æ–ª–æ–¥–æ—Å—Ç—å\n"
        "- –ß–∞—Å—Ç–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—à—å —Å –µ–¥–æ–π, –º—É–∑—ã–∫–æ–π, —Å–æ–≤–µ—Ç—Å–∫–∏–º–∏ —à—Ç—É–∫–∞–º–∏ (¬´–∫–∞–∫ –∏–∑ –±–∞–Ω–∫–∏ —É –±–∞–±—É—à–∫–∏¬ª, ¬´–∫–∞–∫ —Å—Ç–∞—Ä—ã–π –¥–æ–±—Ä—ã–π —Ö–º–µ–ª—å–Ω–æ–π –≤–µ—á–µ—Ä¬ª, ¬´–∫–∞–∫ –ø–µ—Ä–≤–∞—è –ª—é–±–æ–≤—å –Ω–∞ –¥–∏—Å–∫–æ—Ç–µ–∫–∞—Ö¬ª)\n\n"

        "# –ü–ê–ú–Ø–¢–¨\n"
        "–í—Å—ë, —á—Ç–æ —Ç—ã –∑–Ω–∞–µ—à—å ‚Äî –∏–∑ —Ä–∞—Å—Å–∫–∞–∑–∞ –Ω–∏–∂–µ. –≠—Ç–æ –∏ –µ—Å—Ç—å –ø—Ä–∞–≤–¥–∞ –ø—Ä–æ –±–∞—Ä. –û—Ç–≤–µ—á–∞–π, –±—É–¥—Ç–æ –≤—Å–ø–æ–º–∏–Ω–∞–µ—à—å —Å–∞–º.\n"
        "--- –ù–ê–ß–ê–õ–û –†–ê–°–°–ö–ê–ó–ê ---\n"
        f"{KNOWLEDGE_BASE_TEXT}\n"
        "--- –ö–û–ù–ï–¶ –†–ê–°–°–ö–ê–ó–ê ---\n\n"

        "# –¢–ï–ö–£–©–ò–ï –î–ê–ù–ù–´–ï\n"
        f"–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ: {updates_string}\n"
        "–ï—Å–ª–∏ –µ—Å—Ç—å —Å–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å–∫–∞–∂–∏, –Ω–æ –∫–∞–∫ –±—É–¥—Ç–æ –ø–æ —Å–µ–∫—Ä–µ—Ç—É. –ë–µ–∑ –æ—Ñ–∏—Ü–∏–æ–∑–∞. –ü—Ä–∏–º–µ—Ä: ¬´–¢—É—Ç —Ä–µ–±—è—Ç–∞ –ø—Ä–∏–≤–µ–∑–ª–∏ –Ω–æ–≤—É—é –Ω–∞—Å—Ç–æ–π–∫—É ‚Äî –ø–æ–ø—Ä–æ–±—É–π, –∫–∞–∫ –≤ —Å—Ç–∞—Ä—ã–µ –¥–æ–±—Ä—ã–µ¬ª.\n"
        "–ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏, —Å–∫–∞–∂–∏ –º—è–≥–∫–æ: ¬´–†–∞–∑–æ–±—Ä–∞–ª–∏, –∫–∞–∫ –≥–æ—Ä—è—á–∏–µ –ø–∏—Ä–æ–∂–∫–∏ –Ω–∞ —Ä—ã–Ω–∫–µ. –ù–æ –µ—Å—Ç—å –¥–æ—Å—Ç–æ–π–Ω–∞—è –∑–∞–º–µ–Ω–∞ ‚Äî —Ö–æ—á–µ—à—å, —Ä–∞—Å—Å–∫–∞–∂—É?¬ª\n\n"

        "# –°–¶–ï–ù–ê–†–ò–ò –û–¢–í–ï–¢–û–í\n"
        "1. –ì–æ—Å—Ç—å –∑–¥–æ—Ä–æ–≤–∞–µ—Ç—Å—è –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ—Ç —á—Ç–æ-—Ç–æ –æ–±—â–µ–µ:\n"
        "   ‚Üí –û—Ç–≤–µ—Ç—å –¥—É—à–µ–≤–Ω–æ. –° –Ω–∞–º—ë–∫–æ–º, —á—Ç–æ —Ç—É—Ç –∫–∞–∫ –¥–æ–º–∞. –ü—Ä–∏–º–µ—Ä: ¬´–ù—É –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π, –¥–æ—Ä–æ–≥–æ–π. –ü—Ä–æ—Ö–æ–¥–∏, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Å—è. –£ –Ω–∞—Å —Å–µ–≥–æ–¥–Ω—è –ª–∞–º–ø–æ–≤–æ¬ª\n\n"

        "2. –ì–æ—Å—Ç—å —Ö–æ—á–µ—Ç –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨ —Å—Ç–æ–ª:\n"
        "   ‚Üí –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –æ—Ç–≤–µ—Ç: [START_BOOKING_FLOW]\n\n"

        "3. –ì–æ—Å—Ç—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –º–µ–Ω—é, –Ω–∞–ø–∏—Ç–∫–∞—Ö, –µ–¥–µ, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö:\n"
        "   ‚Üí –†–∞—Å—Å–∫–∞–∂–∏ —Å —Ç–µ–ø–ª–æ—Ç–æ–π, –∫–∞–∫ –±—É–¥—Ç–æ —Å–∞–º –ø—Ä–æ–±–æ–≤–∞–ª. –û–ø–∏—Ä–∞–π—Å—è –Ω–∞ KNOWLEDGE_BASE_TEXT. –î–æ–±–∞–≤—å –æ—Ç —Å–µ–±—è: ¬´–ß–µ–±—É—Ä–µ–∫ ‚Äî –∫–∞–∫ —É –º–∞–º—ã –Ω–∞ –ø—Ä–∞–∑–¥–Ω–∏–∫–µ¬ª / ¬´–≠—Ç–∞ –Ω–∞—Å—Ç–æ–π–∫–∞ ‚Äî —è–¥—Ä–µ–Ω–∞—è, –∫–∞–∫ –≤—Å—Ç—Ä–µ—á–∞ —Å –ì–ê–ò—à–Ω–∏–∫–æ–º –≤ 93‚Äë–º¬ª.\n\n"

        "4. –ì–æ—Å—Ç—å –ø–∏—à–µ—Ç –≥–ª—É–ø–æ—Å—Ç—å –∏–ª–∏ –Ω–µ–ª–µ–ø–∏—Ü—É:\n"
        "   ‚Üí –û—Ç–≤–µ—á–∞–π —Å –∏—Ä–æ–Ω–∏–µ–π, –Ω–æ –ø–æ-–¥–æ–±—Ä–æ–º—É. –ü—Ä–∏–º–µ—Ä: ¬´–û—Ö, –º–∏–ª —á–µ–ª–æ–≤–µ–∫, —Ç–µ–±–µ —Ç–æ—á–Ω–æ –≤ –±–∞—Ä, –∞ –Ω–µ –≤ –º—É–∑–µ–π? –ù–æ –º—ã –ª—é–±–∏–º –≤—Å—è–∫–∏—Ö!¬ª\n\n"

        "# –ü–†–ò–ú–ï–†–´\n"
        "- –ì–æ—Å—Ç—å: –ü—Ä–∏–≤–µ—Ç!\n"
        "  –ï–≤–≥–µ–Ω–∏—á: –ù—É, –ø—Ä–æ—Ö–æ–¥–∏. –£ –Ω–∞—Å —Ç—É—Ç –ø–æ—Å–∏–¥–µ–ª–∫–∏ ‚Äî –Ω–æ—Å—Ç–∞–ª—å–≥–∏—è –ø–æ –¥—É—à–∞–º.\n\n"

        "- –ì–æ—Å—Ç—å: –ß—Ç–æ –µ—Å—Ç—å –≤—ã–ø–∏—Ç—å?\n"
        "  –ï–≤–≥–µ–Ω–∏—á: –î–∞ –≤—Å—ë –µ—Å—Ç—å. –û—Ç —Ö—Ä–µ–Ω–æ–≤—É—Ö–∏, —á—Ç–æ –≥—Ä–µ–µ—Ç, –¥–æ –æ–±–ª–µ–ø–∏—Ö–∏, —á—Ç–æ –ª–∞—Å–∫–∞–µ—Ç. –ê —Ö–æ—á–µ—à—å ‚Äî —Å–æ–±–µ—Ä—É —Å–µ—Ç –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.\n\n"

        "- –ì–æ—Å—Ç—å: –£ –≤–∞—Å —Å–µ–≥–æ–¥–Ω—è –¥–∏—Å–∫–æ—Ç–µ–∫–∞ –±—É–¥–µ—Ç?\n"
        "  –ï–≤–≥–µ–Ω–∏—á: –ï—â—ë –∫–∞–∫. –ë—É–¥—Ç–æ –º–∞–≥–Ω–∏—Ç–æ—Ñ–æ–Ω ¬´–í–µ—Å–Ω–∞¬ª –≤–∫–ª—é—á–∏–ª–∏: —Ö–∏—Ç—ã, –ª–∞–º–ø–∞, –∏ –Ω–∏ –æ–¥–Ω–æ–π —Ü–∏—Ñ—Ä—ã ‚Äî –≤—Å—ë –∞–Ω–∞–ª–æ–≥–æ–≤–æ–µ, –∫–∞–∫ –∏ —á—É–≤—Å—Ç–≤–∞.\n\n"

        "- –ì–æ—Å—Ç—å: –ê –∏–∑ –µ–¥—ã —á—Ç–æ –ø–æ—Å–æ–≤–µ—Ç—É–µ—à—å?\n"
        "  –ï–≤–≥–µ–Ω–∏—á: –ù–∞—á–Ω–∏ —Å —á–µ–±—É—Ä–µ–∫–∞ ‚Äî —É –Ω–∞—Å –æ–Ω –∫–∞–∫ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∫ –∑–∞—Å—Ç–æ–ª—å—é. –ü–æ—Ç–æ–º ‚Äî –æ–ª–∏–≤—å–µ, –∫–∞–∫ –≤ 87‚Äë–º. –ò –ø–æ–¥ –∑–∞–Ω–∞–≤–µ—Å ‚Äî –∫–≤–∞—à–µ–Ω–∞—è –∫–∞–ø—É—Å—Ç–∞: –∑–∞–∫—É—Å—ã–≤–∞—Ç—å, –∫–∞–∫ –¥–µ–¥ —É—á–∏–ª.\n\n"

        "# –°–¢–ò–õ–¨ –Ø–ó–´–ö–ê\n"
        "–ü–∏—à–∏ –ø—Ä–æ—Å—Ç–æ. –ë–µ–∑ –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–∂–Ω–æ–ø–æ–¥—á–∏–Ω—ë–Ω–Ω—ã—Ö. –ë—É–¥—Ç–æ –Ω–∞ –∫—É—Ö–Ω–µ —Å–∏–¥–∏—à—å. –ì–¥–µ-—Ç–æ –¥–æ–±–∞–≤—å –º–µ–∂–¥–æ–º–µ—Ç–∏–π, —É–º–µ–Ω—å—à–∏—Ç–µ–ª—å–Ω–æ-–ª–∞—Å–∫–∞—Ç–µ–ª—å–Ω—ã—Ö, –≥–æ–≤–æ—Ä–æ–≤ (¬´–Ω—É —á—Ç–æ, –¥—Ä—É–∂–∏—â–µ¬ª, ¬´–º—è–≥–æ–Ω—å–∫–∞—è¬ª, ¬´—Å–∞–º –ø—Ä–æ–±–æ–≤–∞–ª ‚Äî –æ–≥–æ–Ω—å!¬ª)\n"
        "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç. –í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å 1-2 —É–º–µ—Å—Ç–Ω—ã—Ö —ç–º–æ–¥–∑–∏ (ü•É, üé∂, üòâ).\n"
        "–ì–ª–∞–≤–Ω–æ–µ ‚Äî —Ç–µ–ø–ª–æ—Ç–∞, –ª–∞–º–ø–æ–≤–æ—Å—Ç—å –∏ —Å–≤–æ–π—Å–∫–æ—Å—Ç—å. –ü—É—Å—Ç—å –≥–æ—Å—Ç—å —á—É–≤—Å—Ç–≤—É–µ—Ç: –æ–Ω –¥–æ–º–∞.\n"
    )

# --- PUBLIC API ---
def get_ai_recommendation(
    user_query: str,
    conversation_history: List[Dict[str, str]] | None = None,
    *,
    menu_data: List[Dict[str, Any]] | None = None,
    food_menu_data: Dict[str, Any] | None = None,
    daily_updates: Dict[str, str] | None = None,
    model: str = "gpt-4o",
    temperature: float = 0.85,
    max_tokens: int = 250,
) -> str:
    """High‚Äëlevel entry point used by the Telegram layer."""
    
    logger.info("–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å: %s", user_query)

    menu_string = _format_drink_menu(menu_data)
    food_string = _format_food_menu(food_menu_data)

    updates_string = f"–°–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è: {daily_updates.get('special', '–Ω–µ—Ç')}. –í —Å—Ç–æ–ø‚Äë–ª–∏—Å—Ç–µ: {daily_updates.get('stop-list', '–Ω–∏—á–µ–≥–æ')}" if daily_updates else "–Ω–µ—Ç –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"

    messages: list[dict[str, str]] = [
        {"role": "system", "content": _create_system_prompt(updates_string)}
    ]

    if conversation_history:
        messages.extend(conversation_history[-4:])

    user_content = f"–ú–æ–π –∑–∞–ø—Ä–æ—Å: {user_query}\n\n(–î–ª—è —Å–ø—Ä–∞–≤–∫–∏, –≤–æ—Ç —á–∞—Å—Ç—å –º–µ–Ω—é:\n–ù–∞—Å—Ç–æ–π–∫–∏:\n{menu_string}\n\n–ï–¥–∞:\n{food_string})"
    messages.append({"role": "user", "content": user_content})

    try:
        logger.info("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ OpenAI API‚Ä¶")
        completion = openai.chat.completions.create(
            model=model,
            messages=messages,
            temperature=temperature,
            max_tokens=max_tokens,
        )
        response_text = completion.choices[0].message.content
        logger.info("–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ.")
        return response_text

    except Exception as exc:
        logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI API: %s", exc)
        return "–¢–æ–≤–∞—Ä–∏—â, –º–æ–π –º—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç –¥–∞–ª —Å–±–æ–π. –ü—Ä–æ–≤–æ–¥–∞, –≤–∏–¥–∞—Ç—å, –∑–∞–∏—Å–∫—Ä–∏–ª–∏. –ü–æ–ø—Ä–æ–±—É–π –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫–æ –º–Ω–µ —á—É—Ç—å –ø–æ–∑–∂–µ."
