{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - Evgenich Bot Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    –ü–æ–¥—Ä–æ–±–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="periodSelect" class="form-label">–ü–µ—Ä–∏–æ–¥:</label>
                        <select class="form-select" id="periodSelect" onchange="updateCharts()">
                            <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                            <option value="14">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π</option>
                            <option value="30">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                        </select>
                    </div>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-4 text-center">
                                <div class="h4 text-primary" id="totalIssued">-</div>
                                <small class="text-muted">–í—Å–µ–≥–æ –≤—ã–¥–∞–Ω–æ</small>
                            </div>
                            <div class="col-4 text-center">
                                <div class="h4 text-success" id="totalRedeemed">-</div>
                                <small class="text-muted">–í—Å–µ–≥–æ –ø–æ–≥–∞—à–µ–Ω–æ</small>
                            </div>
                            <div class="col-4 text-center">
                                <div class="h4 text-info" id="avgConversion">-</div>
                                <small class="text-muted">–°—Ä–µ–¥–Ω—è—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- –î–∏–Ω–∞–º–∏–∫–∞ –≤—ã–¥–∞—á–∏ –∏ –ø–æ–≥–∞—à–µ–Ω–∏—è -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    –î–∏–Ω–∞–º–∏–∫–∞ –≤—ã–¥–∞—á–∏ –∏ –ø–æ–≥–∞—à–µ–Ω–∏—è –∫—É–ø–æ–Ω–æ–≤
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="dynamicsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ –¥–Ω—è–º -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-percentage me-2"></i>
                    –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ –¥–Ω—è–º
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="conversionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ (–∑–∞ –ø–µ—Ä–∏–æ–¥)
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="sourcesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>
                    –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º –¥–Ω—è
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π –ø–æ —á–∞—Å–∞–º</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-users-cog me-2"></i>
                    –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ (–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥)
                </h6>
            </div>
            <div class="card-body">
                <div id="staffStats">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let dynamicsChart, conversionChart, sourcesChart, hourlyChart;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
function initCharts() {
    // –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏
    const dynamicsCtx = document.getElementById('dynamicsChart').getContext('2d');
    dynamicsChart = new Chart(dynamicsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '–í—ã–¥–∞–Ω–æ',
                data: [],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: '–ü–æ–≥–∞—à–µ–Ω–æ',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
    
    // –ì—Ä–∞—Ñ–∏–∫ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
    const conversionCtx = document.getElementById('conversionChart').getContext('2d');
    conversionChart = new Chart(conversionCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è %',
                data: [],
                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
    
    // –ì—Ä–∞—Ñ–∏–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    const sourcesCtx = document.getElementById('sourcesChart').getContext('2d');
    sourcesChart = new Chart(sourcesCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB', 
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ —á–∞—Å–∞–º
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    hourlyChart = new Chart(hourlyCtx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',
                data: new Array(24).fill(0),
                backgroundColor: 'rgba(153, 102, 255, 0.6)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
function updateCharts() {
    const days = document.getElementById('periodSelect').value;
    
    fetch(`/api/stats?days=${days}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–Ω–∞–º–∏–∫—É
                dynamicsChart.data.labels = data.data.map(item => {
                    const date = new Date(item.date);
                    return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
                });
                dynamicsChart.data.datasets[0].data = data.data.map(item => item.issued);
                dynamicsChart.data.datasets[1].data = data.data.map(item => item.redeemed);
                dynamicsChart.update();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω–≤–µ—Ä—Å–∏—é
                conversionChart.data.labels = data.data.map(item => {
                    const date = new Date(item.date);
                    return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
                });
                conversionChart.data.datasets[0].data = data.data.map(item => item.conversion);
                conversionChart.update();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º–∞—Ä–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const totalIssued = data.data.reduce((sum, item) => sum + item.issued, 0);
                const totalRedeemed = data.data.reduce((sum, item) => sum + item.redeemed, 0);
                const avgConversion = totalIssued > 0 ? ((totalRedeemed / totalIssued) * 100).toFixed(1) : '0';
                
                document.getElementById('totalIssued').textContent = totalIssued;
                document.getElementById('totalRedeemed').textContent = totalRedeemed;
                document.getElementById('avgConversion').textContent = avgConversion + '%';
                
                // –°–∏–º—É–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —á–∞—Å–æ–≤ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ API)
                updateSourcesChart();
                updateHourlyChart();
                updateStaffStats(days);
            }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error));
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞)
function updateSourcesChart() {
    sourcesChart.data.labels = ['–ü—Ä—è–º–æ–π –∑–∞—Ö–æ–¥', '–ü–µ—Ä—Å–æ–Ω–∞–ª', '–†–µ–∫–ª–∞–º–∞', '–°–æ—Ü.—Å–µ—Ç–∏', '–î—Ä—É–≥–æ–µ'];
    sourcesChart.data.datasets[0].data = [45, 25, 15, 10, 5]; // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    sourcesChart.update();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ —á–∞—Å–∞–º (–∑–∞–≥–ª—É—à–∫–∞)
function updateHourlyChart() {
    // –°–∏–º—É–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ —á–∞—Å–∞–º
    const hourlyData = new Array(24).fill(0).map((_, i) => {
        if (i >= 10 && i <= 23) return Math.floor(Math.random() * 15) + 1;
        return Math.floor(Math.random() * 3);
    });
    
    hourlyChart.data.datasets[0].data = hourlyData;
    hourlyChart.update();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞
function updateStaffStats(days) {
    document.getElementById('staffStats').innerHTML = `
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <div class="h3 text-success">ü•á</div>
                        <div class="fw-bold">–ò–≤–∞–Ω –ü.</div>
                        <div class="text-muted">–û—Ñ–∏—Ü–∏–∞–Ω—Ç</div>
                        <div class="h4 text-success">+24</div>
                        <small class="text-muted">–Ω–æ–≤—ã—Ö –≥–æ—Å—Ç–µ–π</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <div class="h3 text-warning">ü•à</div>
                        <div class="fw-bold">–ú–∞—Ä–∏—è –°.</div>
                        <div class="text-muted">–ë–∞—Ä–º–µ–Ω</div>
                        <div class="h4 text-warning">+18</div>
                        <small class="text-muted">–Ω–æ–≤—ã—Ö –≥–æ—Å—Ç–µ–π</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-secondary">
                    <div class="card-body text-center">
                        <div class="h3 text-secondary">ü•â</div>
                        <div class="fw-bold">–ê–ª–µ–∫—Å–µ–π –ö.</div>
                        <div class="text-muted">–ú–µ–Ω–µ–¥–∂–µ—Ä</div>
                        <div class="h4 text-secondary">+12</div>
                        <small class="text-muted">–Ω–æ–≤—ã—Ö –≥–æ—Å—Ç–µ–π</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                –î–∞–Ω–Ω—ã–µ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (${days} –¥–Ω–µ–π)
            </small>
        </div>
    `;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    updateCharts();
});
</script>
{% endblock %}
