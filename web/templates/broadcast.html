{% extends "base.html" %}

{% block title %}–†–∞—Å—Å—ã–ª–∫–∏ - –ï–≤–≥–µ–Ω–∏—á{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-4">
        <h2 class="mb-0">üì® –†–∞—Å—Å—ã–ª–∫–∏</h2>
        <p class="text-muted">–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞</p>
    </div>

    <div class="row">
        <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">–ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h5>
                </div>
                <div class="card-body">
                    <form id="broadcastForm">
                        <!-- –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å?</label>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="card">
                                        <input type="radio" class="btn-check" name="target" id="targetAll" value="all" checked>
                                        <label class="card-body text-center" for="targetAll" style="cursor: pointer;">
                                            <i class="fas fa-users fs-3 mb-2 text-primary"></i>
                                            <h6>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h6>
                                            <p class="text-muted small mb-0" id="allCount">~ —á–µ–ª–æ–≤–µ–∫</p>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <input type="radio" class="btn-check" name="target" id="targetActive" value="active">
                                        <label class="card-body text-center" for="targetActive" style="cursor: pointer;">
                                            <i class="fas fa-user-check fs-3 mb-2 text-success"></i>
                                            <h6>–ê–∫—Ç–∏–≤–Ω—ã–µ</h6>
                                            <p class="text-muted small mb-0">–ü–æ–≥–∞—Å–∏–ª–∏ –∫—É–ø–æ–Ω</p>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <input type="radio" class="btn-check" name="target" id="targetNew" value="new">
                                        <label class="card-body text-center" for="targetNew" style="cursor: pointer;">
                                            <i class="fas fa-user-plus fs-3 mb-2 text-info"></i>
                                            <h6>–ù–æ–≤—ã–µ</h6>
                                            <p class="text-muted small mb-0">–ù–µ –ø–æ–≥–∞—Å–∏–ª–∏ –∫—É–ø–æ–Ω</p>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è *</label>
                            <textarea class="form-control" id="broadcastMessage" rows="6" 
                                      placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏...&#10;&#10;–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Markdown:&#10;*–∂–∏—Ä–Ω—ã–π*&#10;_–∫—É—Ä—Å–∏–≤_&#10;`–∫–æ–¥`"></textarea>
                            <small class="text-muted">–ú–∞–∫—Å. 4096 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Markdown</small>
                        </div>

                        <!-- –ü—Ä–µ–≤—å—é -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</label>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div id="messagePreview" class="text-muted fst-italic">
                                        –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="withButton">
                                    <label class="form-check-label" for="withButton">
                                        –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sendTest">
                                    <label class="form-check-label" for="sendTest">
                                        –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç —Å–µ–±–µ
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div id="buttonSettings" class="mb-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="buttonText" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏">
                                </div>
                                <div class="col-md-6">
                                    <input type="url" class="form-control" id="buttonUrl" placeholder="URL —Å—Å—ã–ª–∫–∏">
                                </div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" onclick="sendBroadcast()">
                                <i class="fas fa-paper-plane me-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                            </button>
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-2"></i>–û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫ -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫</h5>
                </div>
                <div class="card-body" id="broadcastHistory">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fs-1 mb-3 d-block"></i>
                        <p>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫ –ø—É—Å—Ç–∞</p>
                    </div>
                </div>
            </div>
            
            <!-- –ë—ã—Å—Ç—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã -->
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-white">
                    <h5 class="mb-0">–ë—ã—Å—Ç—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm text-start" onclick="useTemplate('promo')">
                            <i class="fas fa-gift me-2"></i>–ü—Ä–æ–º–æ–∞–∫—Ü–∏—è
                        </button>
                        <button class="btn btn-outline-success btn-sm text-start" onclick="useTemplate('event')">
                            <i class="fas fa-calendar me-2"></i>–°–æ–±—ã—Ç–∏–µ
                        </button>
                        <button class="btn btn-outline-info btn-sm text-start" onclick="useTemplate('reminder')">
                            <i class="fas fa-bell me-2"></i>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                        </button>
                        <button class="btn btn-outline-warning btn-sm text-start" onclick="useTemplate('greeting')">
                            <i class="fas fa-hand-sparkles me-2"></i>–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
document.getElementById('broadcastMessage').addEventListener('input', function() {
    const preview = document.getElementById('messagePreview');
    const text = this.value;
    if (text) {
        // –ü—Ä–æ—Å—Ç–æ–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ Markdown
        let html = text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>');
        preview.innerHTML = html;
    } else {
        preview.innerHTML = '<span class="text-muted fst-italic">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...</span>';
    }
});

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–Ω–æ–ø–∫–∏
document.getElementById('withButton').addEventListener('change', function() {
    document.getElementById('buttonSettings').style.display = this.checked ? 'block' : 'none';
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
function sendBroadcast() {
    const message = document.getElementById('broadcastMessage').value;
    if (!message.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è!');
        return;
    }
    
    const target = document.querySelector('input[name="target"]:checked').value;
    const sendTest = document.getElementById('sendTest').checked;
    
    if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –¥–ª—è –≥—Ä—É–ø–ø—ã "${target}"?${sendTest ? '\n\n–°–Ω–∞—á–∞–ª–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç.' : ''}`)) {
        return;
    }
    
    const data = {
        message: message,
        target: target,
        sendTest: sendTest,
        withButton: document.getElementById('withButton').checked
    };
    
    if (data.withButton) {
        data.buttonText = document.getElementById('buttonText').value;
        data.buttonUrl = document.getElementById('buttonUrl').value;
    }
    
    fetch('/api/broadcast', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
            document.getElementById('broadcastForm').reset();
            document.getElementById('messagePreview').innerHTML = '<span class="text-muted fst-italic">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...</span>';
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏');
    });
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
function useTemplate(type) {
    const templates = {
        'promo': 'üéÅ *–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!*\n\n–£ –Ω–∞—Å –Ω–æ–≤–∞—è –∞–∫—Ü–∏—è:\n\n...\n\n–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ [–¥–∞—Ç–∞]!\n–ü—Ä–∏—Ö–æ–¥–∏ –∏ –ø–æ–ª—É—á–∏ —Å–∫–∏–¥–∫—É! üòä',
        'event': 'üéâ *–°–æ–±—ã—Ç–∏–µ –≤ –ï–≤–≥–µ–Ω–∏—á–µ!*\n\n–ü—Ä–∏–≥–ª–∞—à–∞–µ–º —Ç–µ–±—è –Ω–∞:\n\n...\n\n–ö–æ–≥–¥–∞: [–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è]\n–ì–¥–µ: [–∞–¥—Ä–µ—Å]\n\n–ë—É–¥–µ—Ç –∫—Ä—É—Ç–æ! üî•',
        'reminder': '‚è∞ *–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ*\n\n–¢–æ–≤–∞—Ä–∏—â, –Ω–µ –∑–∞–±—É–¥—å:\n\n...\n\n–ñ–¥—ë–º —Ç–µ–±—è! üëã',
        'greeting': 'üëã *–ü—Ä–∏–≤–µ—Ç!*\n\n–î–∞–≤–Ω–æ –Ω–µ –≤–∏–¥–µ–ª–∏—Å—å!\n\n–ö–∞–∫ –¥–µ–ª–∞? –ó–∞—Ö–æ–¥–∏ –∫ –Ω–∞–º, –±—É–¥–µ–º —Ä–∞–¥—ã üòä\n\n–£ –Ω–∞—Å [—á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ]!'
    };
    
    document.getElementById('broadcastMessage').value = templates[type] || '';
    document.getElementById('broadcastMessage').dispatchEvent(new Event('input'));
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
window.addEventListener('DOMContentLoaded', function() {
    // TODO: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    document.getElementById('allCount').textContent = '~ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
});
</script>

<style>
.btn-check:checked + label {
    background-color: #e3f2fd;
    border-color: #2196f3;
}
</style>
{% endblock %}
