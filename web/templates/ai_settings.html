{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</h2>
            <p class="text-muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –≤ –±–æ—Ç–µ</p>
        </div>
    </div>
    
    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>–£—Å–ø–µ—à–Ω–æ!</strong> {{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üí¨ –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="/ai/update">
                        <input type="hidden" name="section" value="system_prompt">
                        
                        <div class="mb-3">
                            <label class="form-label">–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç</label>
                            <textarea class="form-control" name="system_prompt" rows="10">{{ ai_settings.system_prompt }}</textarea>
                            <small class="text-muted">–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–ª—å –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ AI</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">–¢–æ–Ω –æ–±—â–µ–Ω–∏—è</label>
                            <select class="form-select" name="tone">
                                <option value="friendly" {% if ai_settings.tone == 'friendly' %}selected{% endif %}>–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π</option>
                                <option value="professional" {% if ai_settings.tone == 'professional' %}selected{% endif %}>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π</option>
                                <option value="casual" {% if ai_settings.tone == 'casual' %}selected{% endif %}>–ù–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
                                <option value="formal" {% if ai_settings.tone == 'formal' %}selected{% endif %}>–§–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="/ai/update">
                        <input type="hidden" name="section" value="knowledge">
                        
                        <div class="mb-3">
                            <label class="form-label">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞—Ä–µ</label>
                            <textarea class="form-control" name="bar_info" rows="5">{{ ai_settings.bar_info }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">–ú–µ–Ω—é –∏ —Ü–µ–Ω—ã</label>
                            <textarea class="form-control" name="menu_info" rows="5">{{ ai_settings.menu_info }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">–ü—Ä–∞–≤–∏–ª–∞ –∏ –ø–æ–ª–∏—Ç–∏–∫–∞</label>
                            <textarea class="form-control" name="rules" rows="5">{{ ai_settings.rules }}</textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="/ai/update">
                        <input type="hidden" name="section" value="parameters">
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0.0-2.0)</label>
                                    <input type="number" class="form-control" name="temperature" value="{{ ai_settings.temperature }}" min="0" max="2" step="0.1">
                                    <small class="text-muted">–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤</small>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">–ú–∞–∫—Å. —Ç–æ–∫–µ–Ω–æ–≤</label>
                                    <input type="number" class="form-control" name="max_tokens" value="{{ ai_settings.max_tokens }}" min="100" max="4000">
                                    <small class="text-muted">–î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞</small>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">–ú–æ–¥–µ–ª—å</label>
                                    <select class="form-select" name="model">
                                        <option value="gpt-4" {% if ai_settings.model == 'gpt-4' %}selected{% endif %}>GPT-4</option>
                                        <option value="gpt-4-turbo" {% if ai_settings.model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
                                        <option value="gpt-3.5-turbo" {% if ai_settings.model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-info">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI</h5>
                </div>
                <div class="card-body">
                    <form id="testAIForm">
                        <div class="mb-3">
                            <label class="form-label">–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</label>
                            <input type="text" class="form-control" id="testQuery" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∫–∏–µ —É –≤–∞—Å –Ω–∞—Å—Ç–æ–π–∫–∏?" required>
                        </div>
                        <button type="submit" class="btn btn-warning">üß™ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </form>
                    
                    <div id="testResult" class="mt-3" style="display: none;">
                        <div class="alert alert-secondary">
                            <strong>–û—Ç–≤–µ—Ç AI:</strong>
                            <div id="aiResponse" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('testAIForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const query = document.getElementById('testQuery').value;
    const resultDiv = document.getElementById('testResult');
    const responseDiv = document.getElementById('aiResponse');
    
    responseDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> –î—É–º–∞—é...';
    resultDiv.style.display = 'block';
    
    try {
        const response = await fetch('/ai/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({query: query})
        });
        const data = await response.json();
        responseDiv.textContent = data.response || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞';
    } catch (error) {
        responseDiv.textContent = '–û—à–∏–±–∫–∞: ' + error.message;
    }
});
</script>
{% endblock %}
