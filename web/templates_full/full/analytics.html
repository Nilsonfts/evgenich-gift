{% extends "full/base.html" %}
{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞{% endblock %}

{% block content %}
<div class="page-h">
    <h2><i class="fas fa-chart-line me-2"></i>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
    <p>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç—ã</p>
</div>

<!-- Broadcast stats -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div><small>–í—Å–µ–≥–æ –≤ –±–∞–∑–µ</small><h3>{{ bstats.total or 0 }}</h3></div>
                <div class="icon" style="background:linear-gradient(135deg,#6366f1,#8b5cf6)"><i class="fas fa-database"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div><small>–ê–∫—Ç–∏–≤–Ω—ã—Ö</small><h3 style="color:#10b981">{{ bstats.active or 0 }}</h3></div>
                <div class="icon" style="background:linear-gradient(135deg,#10b981,#059669)"><i class="fas fa-user-check"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div><small>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏</small><h3 style="color:#ef4444">{{ bstats.blocked or 0 }}</h3></div>
                <div class="icon" style="background:linear-gradient(135deg,#ef4444,#dc2626)"><i class="fas fa-user-slash"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div><small>–ù–æ–≤—ã—Ö –∑–∞ 30 –¥–Ω–µ–π</small><h3 style="color:#3b82f6">{{ bstats.recent_30d or 0 }}</h3></div>
                <div class="icon" style="background:linear-gradient(135deg,#3b82f6,#2563eb)"><i class="fas fa-calendar-plus"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- Reports selector -->
<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="table-card">
            <div class="card-header d-flex align-items-center justify-content-between">
                <span><i class="fas fa-file-alt me-2"></i>–û—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" onclick="loadReport('shift', event)">–°–º–µ–Ω–∞</button>
                    <button class="btn btn-outline-primary" onclick="loadReport('24h', event)">24—á</button>
                    <button class="btn btn-outline-primary" onclick="loadReport('7d', event)">7 –¥–Ω–µ–π</button>
                    <button class="btn btn-outline-primary" onclick="loadReport('30d', event)">30 –¥–Ω–µ–π</button>
                </div>
            </div>
            <div class="p-3" id="reportContent">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
        </div>
    </div>

    <!-- Churn analysis -->
    <div class="col-lg-4">
        <div class="table-card h-100">
            <div class="card-header"><i class="fas fa-chart-pie me-2"></i>–ê–Ω–∞–ª–∏–∑ –æ—Ç—Ç–æ–∫–∞</div>
            <div class="p-3">
                {% if churn %}
                    {% if churn is mapping %}
                        {% for key, val in churn.items() %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ key }}</span>
                            <span class="fw-bold">{{ val }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">{{ churn }}</p>
                    {% endif %}
                {% else %}
                    <p class="text-muted text-center py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ç—Ç–æ–∫–µ</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Referral leaders -->
<div class="row g-3">
    <div class="col-lg-6">
        <div class="table-card">
            <div class="card-header"><i class="fas fa-medal me-2"></i>–¢–æ–ø —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –∑–∞ –º–µ—Å—è—Ü</div>
            <div class="p-3">
                {% if leaders %}
                <table class="table table-sm table-hover">
                    <thead><tr><th>#</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th class="text-end">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</th></tr></thead>
                    <tbody>
                    {% for l in leaders %}
                    <tr>
                        <td>{% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ loop.index }}{% endif %}</td>
                        <td>
                            <a href="/users/{{ l.user_id or l[0] }}" class="text-decoration-none">
                                {{ l.first_name or l.username or l.user_id or l[0] or '‚Äî' }}
                            </a>
                        </td>
                        <td class="text-end fw-bold">{{ l.count or l.referral_count or l[1] or 0 }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted text-center py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Funnel -->
    <div class="col-lg-6">
        <div class="table-card">
            <div class="card-header"><i class="fas fa-filter me-2"></i>–í–æ—Ä–æ–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            <div class="p-3">
                <canvas id="funnelChart" style="height:250px"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadReport(period, e){
    const el=document.getElementById('reportContent');
    el.innerHTML='<div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin me-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    document.querySelectorAll('.btn-group .btn').forEach(b=>b.classList.remove('active'));
    if(e && e.target) e.target.classList.add('active');

    fetch('/api/report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({period})})
    .then(r=>r.json()).then(d=>{
        const r=d.report||{};
        const issued=r.issued||0, redeemed=r.redeemed||0;
        const conv=issued>0?((redeemed/issued)*100).toFixed(1):0;
        el.innerHTML=`
            <div class="row g-3">
                <div class="col-4 text-center">
                    <div class="fw-bold" style="font-size:2rem;color:#6366f1">${issued}</div>
                    <small class="text-muted">–ö—É–ø–æ–Ω–æ–≤ –≤—ã–¥–∞–Ω–æ</small>
                </div>
                <div class="col-4 text-center">
                    <div class="fw-bold" style="font-size:2rem;color:#10b981">${redeemed}</div>
                    <small class="text-muted">–ü–æ–≥–∞—à–µ–Ω–æ</small>
                </div>
                <div class="col-4 text-center">
                    <div class="fw-bold" style="font-size:2rem;color:#f59e0b">${conv}%</div>
                    <small class="text-muted">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</small>
                </div>
            </div>
            <div class="text-muted mt-3" style="font-size:.8rem">
                –ü–µ—Ä–∏–æ–¥: ${new Date(d.start).toLocaleString('ru')} ‚Äî ${new Date(d.end).toLocaleString('ru')}
            </div>`;
    }).catch(()=>{el.innerHTML='<p class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>'});
}
loadReport('shift');

// Funnel chart
const total={{bstats.total or 0}}, active={{bstats.active or 0}}, blocked={{bstats.blocked or 0}};
new Chart(document.getElementById('funnelChart'),{
    type:'doughnut',
    data:{
        labels:['–ê–∫—Ç–∏–≤–Ω—ã–µ','–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏','–ù–æ–≤—ã–µ 30–¥'],
        datasets:[{data:[active,blocked,{{bstats.recent_30d or 0}}],backgroundColor:['#10b981','#ef4444','#3b82f6'],borderWidth:0}]
    },
    options:{responsive:true,plugins:{legend:{position:'bottom'}}}
});
</script>
{% endblock %}
