{% extends "full/base.html" %}
{% block title %}–õ–æ—è–ª—å–Ω–æ—Å—Ç—å GMB{% endblock %}

{% block extra_css %}
<style>
    .loyalty-card{background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);border-radius:1rem;color:#fff;padding:1.5rem;position:relative;overflow:hidden}
    .loyalty-card::after{content:'üéÅ';position:absolute;right:-20px;bottom:-20px;font-size:8rem;opacity:.12}
    .loyalty-card h3{font-weight:800;font-size:2rem;margin:.5rem 0 0}
    .gift-item{background:#fff;border:1px solid var(--border);border-radius:.5rem;padding:.75rem 1rem;margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center}
    .gift-item.available{border-left:3px solid var(--ok)}
    .gift-item.unavailable{opacity:.5;border-left:3px solid #cbd5e1}
    .search-result{animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
</style>
{% endblock %}

{% block content %}
<div class="page-h">
    <h2><i class="fas fa-gift me-2"></i>–°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ GetMeBack</h2>
    <p>–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤, –±–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤, –ø–æ–¥–∞—Ä–∫–∏, –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ</p>
</div>

{% if not configured %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <b>GMB API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.</b> –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é <code>GMB_API_KEY</code> –≤ Settings ‚Üí Variables —Å–µ—Ä–≤–∏—Å–∞.
</div>
{% endif %}

<!-- Search -->
<div class="table-card mb-4">
    <div class="card-header"><i class="fas fa-search me-2"></i>–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞</div>
    <div class="p-3">
        <form id="searchForm" class="row g-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="text" id="searchPhone" class="form-control" placeholder="+7 900 123-45-67">
            </div>
            <div class="col-md-3">
                <label class="form-label">–∏–ª–∏ ID –∫–ª–∏–µ–Ω—Ç–∞</label>
                <input type="text" id="searchId" class="form-control" placeholder="12345">
            </div>
            <div class="col-md-3">
                <label class="form-label">–∏–ª–∏ ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
                <input type="text" id="searchDevice" class="form-control" placeholder="abc123...">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100" {% if not configured %}disabled{% endif %}>
                    <i class="fas fa-search me-1"></i>–ù–∞–π—Ç–∏
                </button>
            </div>
        </form>

        <!-- Search result -->
        <div id="searchResult" class="mt-3" style="display:none"></div>
    </div>
</div>

<div class="row g-3">
    <!-- Client card (shown after search) -->
    <div class="col-lg-7">
        <div id="clientSection" style="display:none">
            <!-- Client info card -->
            <div class="loyalty-card mb-3" id="clientCard">
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-user-circle fa-2x me-3" style="opacity:.7"></i>
                    <div>
                        <div style="opacity:.8;font-size:.85rem">–ö–ª–∏–µ–Ω—Ç GMB</div>
                        <h5 class="mb-0 fw-bold" id="clientName">‚Äî</h5>
                    </div>
                </div>
                <h3 id="clientBalance">0</h3>
                <small style="opacity:.8">–±–æ–Ω—É—Å–Ω—ã—Ö –±–∞–ª–ª–æ–≤</small>
                <div class="mt-2 d-flex gap-3" style="font-size:.85rem;opacity:.8">
                    <span><i class="fas fa-phone me-1"></i><span id="clientPhone">‚Äî</span></span>
                    <span><i class="fas fa-percentage me-1"></i>–ö—ç—à–±—ç–∫: <span id="clientKBonus">0</span>%</span>
                    <span><i class="fas fa-credit-card me-1"></i>–û–ø–ª–∞—Ç–∞: –¥–æ <span id="clientMaxPay">0</span>%</span>
                </div>
                <div class="mt-2" style="font-size:.8rem;opacity:.6">
                    ID: <span id="clientId">‚Äî</span> | Device: <span id="clientDevice">‚Äî</span>
                </div>
            </div>

            <!-- Gifts -->
            <div class="table-card mb-3">
                <div class="card-header"><i class="fas fa-gifts me-2"></i>–ü–æ–¥–∞—Ä–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞</div>
                <div class="p-3" id="giftsContainer">
                    <p class="text-muted">–ù–∞–π–¥–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–¥–∞—Ä–∫–æ–≤</p>
                </div>
            </div>
        </div>

        <!-- Bonus accrual form (shown after client found) -->
        <div id="bonusSection" style="display:none">
            <div class="table-card">
                <div class="card-header"><i class="fas fa-coins me-2"></i>–ù–∞—á–∏—Å–ª–∏—Ç—å / –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å—ã</div>
                <div class="p-3">
                    <form id="bonusForm">
                        <input type="hidden" id="bonusClientId">
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ ‚ÇΩ</label>
                                <input type="number" id="orderPrice" class="form-control" min="0" required placeholder="0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–ù–∞—á–∏—Å–ª–∏—Ç—å –±–æ–Ω—É—Å–æ–≤ <small class="text-muted">(–ø—É—Å—Ç–æ = –∞–≤—Ç–æ)</small></label>
                                <input type="number" id="bonusValue" class="form-control" min="0" placeholder="–∞–≤—Ç–æ">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å–æ–≤</label>
                                <input type="number" id="paidBonus" class="form-control" min="0" placeholder="0">
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">–§–∏–ª–∏–∞–ª</label>
                                <select id="branchName" class="form-select">
                                    <option value="–ù–µ–≤—Å–∫–∏–π">–ù–µ–≤—Å–∫–∏–π</option>
                                    <option value="–†—É–±–∏–Ω—à—Ç–µ–π–Ω–∞">–†—É–±–∏–Ω—à—Ç–µ–π–Ω–∞</option>
                                    <option value="–ü—è—Ç–Ω–∏—Ü–∫–∞—è –ú–°–ö">–ü—è—Ç–Ω–∏—Ü–∫–∞—è –ú–°–ö</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
                                <input type="text" id="managerName" class="form-control" value="–ê–¥–º–∏–Ω" placeholder="–ò–º—è">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–ù–æ–º–µ—Ä —á–µ–∫–∞</label>
                                <input type="text" id="invoiceNum" class="form-control" placeholder="–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success me-2">
                            <i class="fas fa-plus-circle me-1"></i>–ù–∞—á–∏—Å–ª–∏—Ç—å
                        </button>
                    </form>
                    <div id="bonusResult" class="mt-3" style="display:none"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <!-- How it works -->
        <div class="table-card mb-3">
            <div class="card-header"><i class="fas fa-info-circle me-2"></i>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
            <div class="p-3" style="font-size:.9rem">
                <p><b>–ü–æ–∏—Å–∫:</b> –í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω, ID –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (QR).</p>
                <p><b>–ë–∞–ª–∞–Ω—Å:</b> –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–Ω—ã—Ö –±–∞–ª–ª–æ–≤.</p>
                <p><b>–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ:</b> –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –∑–∞–∫–∞–∑–∞ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—á–∏—Å–ª–∏—Ç –∫—ç—à–±—ç–∫.</p>
                <p><b>–°–ø–∏—Å–∞–Ω–∏–µ:</b> –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –±–æ–Ω—É—Å–æ–≤ –≤ –ø–æ–ª–µ ¬´–°–ø–∏—Å–∞—Ç—å¬ª –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–∞—Å—Ç–∏ –∑–∞–∫–∞–∑–∞.</p>
                <p><b>–ü–æ–¥–∞—Ä–∫–∏:</b> –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –æ–±–º–µ–Ω—è—Ç—å –±–æ–Ω—É—Å—ã –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏.</p>
                <hr>
                <p class="mb-0 text-muted"><small>API: <code>{{ api_url }}</code></small></p>
            </div>
        </div>

        <!-- Quick actions -->
        <div class="table-card">
            <div class="card-header"><i class="fas fa-bolt me-2"></i>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
            <div class="p-3">
                <a href="https://evgenich.getmeback.ru" target="_blank" class="btn btn-outline-primary w-100 mb-2">
                    <i class="fas fa-external-link-alt me-1"></i>–û—Ç–∫—Ä—ã—Ç—å GMB –ø–∞–Ω–µ–ª—å
                </a>
                <a href="https://evgenich.getmeback.ru/wallet/frontend?code=tg_bot#/auth" target="_blank" class="btn btn-outline-primary w-100">
                    <i class="fas fa-id-card me-1"></i>–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentClientId = null;

document.getElementById('searchForm').addEventListener('submit', function(e){
    e.preventDefault();
    const phone = document.getElementById('searchPhone').value.trim();
    const clientId = document.getElementById('searchId').value.trim();
    const device = document.getElementById('searchDevice').value.trim();

    if(!phone && !clientId && !device){
        showResult('warning', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω, ID –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
        return;
    }

    const params = new URLSearchParams();
    if(phone) params.set('phone', phone);
    if(clientId) params.set('id_client', clientId);
    if(device) params.set('id_device', device);

    showResult('info', '<div class="spinner-border spinner-border-sm me-2"></div>–ü–æ–∏—Å–∫...');

    fetch('/api/loyalty/search?' + params.toString())
        .then(r => r.json())
        .then(data => {
            if(data.error){
                showResult('danger', '<i class="fas fa-times-circle me-2"></i>' + data.error);
                hideClient();
                return;
            }
            if(!data.client){
                showResult('warning', '<i class="fas fa-user-slash me-2"></i>–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –µ—â—ë –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª –∫–∞—Ä—Ç—É.');
                hideClient();
                return;
            }
            showResult('success', '<i class="fas fa-check-circle me-2"></i>–ö–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω!');
            showClient(data.client);
        })
        .catch(err => {
            showResult('danger', '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + err.message);
            hideClient();
        });
});

function showResult(type, html){
    const el = document.getElementById('searchResult');
    el.style.display = 'block';
    el.innerHTML = `<div class="alert alert-${type} search-result mb-0">${html}</div>`;
}

function showClient(c){
    // c might have {client: {...}} or be the client directly
    const client = c.client || c;

    currentClientId = client.id_client || client.id || null;
    document.getElementById('clientName').textContent = client.name || '‚Äî';
    document.getElementById('clientBalance').textContent = client.balance || 0;
    document.getElementById('clientPhone').textContent = client.phone || '‚Äî';
    document.getElementById('clientKBonus').textContent = client.k_bonus || 0;
    document.getElementById('clientMaxPay').textContent = client.maxPayBonusK || 0;
    document.getElementById('clientId').textContent = client.id_client || '‚Äî';
    document.getElementById('clientDevice').textContent = client.id_device || '‚Äî';
    document.getElementById('bonusClientId').value = currentClientId;

    // Gifts
    const gc = document.getElementById('giftsContainer');
    const gifts = client.gifts || [];
    if(gifts.length === 0){
        gc.innerHTML = '<p class="text-muted mb-0">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤</p>';
    } else {
        let html = '';
        gifts.forEach(g => {
            const cls = g.can_use ? 'available' : 'unavailable';
            const icon = g.can_use ? '‚úÖ' : '‚õî';
            html += `<div class="gift-item ${cls}">
                <div>
                    <b>${g.name || '–ü–æ–¥–∞—Ä–æ–∫'}</b>
                    ${g.description ? '<br><small class="text-muted">' + g.description + '</small>' : ''}
                </div>
                <div class="text-end">
                    <span class="fw-bold">${g.price || '?'}</span> –±–æ–Ω—É—Å–æ–≤
                    <br><small>${icon} ${g.can_use ? '–î–æ—Å—Ç—É–ø–µ–Ω' : '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}</small>
                    ${g.can_use ? `<br><button class="btn btn-sm btn-outline-success mt-1" onclick="redeemGift(${g.id_gift || g.id_ext})">üéÅ –í—ã–¥–∞—Ç—å</button>` : ''}
                </div>
            </div>`;
        });
        gc.innerHTML = html;
    }

    document.getElementById('clientSection').style.display = 'block';
    document.getElementById('bonusSection').style.display = 'block';
}

function hideClient(){
    document.getElementById('clientSection').style.display = 'none';
    document.getElementById('bonusSection').style.display = 'none';
    currentClientId = null;
}

// Bonus form
document.getElementById('bonusForm').addEventListener('submit', function(e){
    e.preventDefault();
    if(!currentClientId){
        alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
        return;
    }
    const data = {
        id_client: currentClientId,
        order_price: parseInt(document.getElementById('orderPrice').value) || 0,
        bonus_value: document.getElementById('bonusValue').value ? parseInt(document.getElementById('bonusValue').value) : null,
        paid_bonus: parseInt(document.getElementById('paidBonus').value) || null,
        branch_name: document.getElementById('branchName').value,
        manager_name: document.getElementById('managerName').value,
        invoice_num: document.getElementById('invoiceNum').value,
    };

    if(!data.order_price && !data.bonus_value && !data.paid_bonus){
        alert('–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –∑–∞–∫–∞–∑–∞ –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–Ω—É—Å–æ–≤');
        return;
    }

    if(!confirm(`–ù–∞—á–∏—Å–ª–∏—Ç—å –±–æ–Ω—É—Å—ã –∫–ª–∏–µ–Ω—Ç—É #${currentClientId}?`)) return;

    const res = document.getElementById('bonusResult');
    res.style.display = 'block';
    res.innerHTML = '<div class="alert alert-info"><div class="spinner-border spinner-border-sm me-2"></div>–û—Ç–ø—Ä–∞–≤–∫–∞...</div>';

    fetch('/api/loyalty/accrue', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(d => {
        if(d.result === 'ok'){
            res.innerHTML = `<div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <b>–£—Å–ø–µ—à–Ω–æ!</b> –ù–∞—á–∏—Å–ª–µ–Ω–æ ${d.bonus_value || '?'} –±–æ–Ω—É—Å–æ–≤.
                ${d.bonus_id ? '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è #' + d.bonus_id : ''}
                ${d.client ? '<br>–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: <b>' + d.client.balance + '</b> –±–æ–Ω—É—Å–æ–≤' : ''}
            </div>`;
            // Update displayed balance
            if(d.client){
                document.getElementById('clientBalance').textContent = d.client.balance || 0;
            }
        } else {
            res.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i>${d.message || d.error || '–û—à–∏–±–∫–∞ GMB'}</div>`;
        }
    })
    .catch(err => {
        res.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞: ${err.message}</div>`;
    });
});

function redeemGift(giftId){
    if(!currentClientId || !confirm('–í—ã–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫?')) return;

    fetch('/api/loyalty/gift', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({id_client: currentClientId, id_gift: giftId})
    })
    .then(r => r.json())
    .then(d => {
        if(d.result === 'ok'){
            alert('‚úÖ –ü–æ–¥–∞—Ä–æ–∫ –≤—ã–¥–∞–Ω! –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ' + (d.client ? d.client.balance : '?') + ' –±–æ–Ω—É—Å–æ–≤');
            if(d.client){
                document.getElementById('clientBalance').textContent = d.client.balance || 0;
            }
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (d.message || d.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(err => alert('–û—à–∏–±–∫–∞: ' + err.message));
}
</script>
{% endblock %}
