{% extends "full/base.html" %}
{% block title %}–†–∞—Å—Å—ã–ª–∫–∞ #{{ d.id }}{% endblock %}

{% block content %}
<div class="page-h">
    <h2><i class="fas fa-envelope-open-text me-2"></i>–†–∞—Å—Å—ã–ª–∫–∞ #{{ d.id }}</h2>
    <p>–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –æ—à–∏–±–æ–∫</p>
</div>

<div class="mb-3">
    <a href="/broadcast/history" class="btn btn-outline-primary"><i class="fas fa-arrow-left me-1"></i>–ö –∏—Å—Ç–æ—Ä–∏–∏</a>
    <a href="/broadcast" class="btn btn-outline-secondary ms-2"><i class="fas fa-bullhorn me-1"></i>–ö —Ä–∞—Å—Å—ã–ª–∫–∞–º</a>
</div>

<!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
<div class="row g-3 mb-4">
    <div class="col-xl-2 col-sm-4">
        <div class="stat-card">
            <div class="text-center">
                <small>–í—Å–µ–≥–æ</small>
                <h3>{{ d.total_users or 0 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-sm-4">
        <div class="stat-card">
            <div class="text-center">
                <small>‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</small>
                <h3 style="color:#10b981">{{ d.sent_count or 0 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-sm-4">
        <div class="stat-card">
            <div class="text-center">
                <small>‚ùå –û—à–∏–±–∫–∏</small>
                <h3 style="color:#ef4444">{{ d.failed_count or 0 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-sm-4">
        <div class="stat-card">
            <div class="text-center">
                <small>üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏</small>
                <h3 style="color:#f59e0b">{{ d.blocked_count or 0 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-sm-4">
        <div class="stat-card">
            <div class="text-center">
                <small>üìä –î–æ—Å—Ç–∞–≤–ª—è–µ–º–æ—Å—Ç—å</small>
                <h3 class="{% if (d.delivery_rate or 0) >= 90 %}text-success{% elif (d.delivery_rate or 0) >= 70 %}text-warning{% else %}text-danger{% endif %}">
                    {{ d.delivery_rate or 0 }}%
                </h3>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-sm-4">
        <div class="stat-card">
            <div class="text-center">
                <small>–ò—Å—Ç–æ—á–Ω–∏–∫</small>
                <h3>
                    {% if d.source == 'web' %}
                        <span class="badge bg-info fs-6">Web</span>
                    {% else %}
                        <span class="badge bg-primary fs-6">Bot</span>
                    {% endif %}
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- –ú–µ—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="table-card">
            <div class="card-header"><i class="fas fa-info-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div class="p-3">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>–ù–∞—á–∞–ª–æ:</strong> {{ d.started_at or '‚Äî' }}</p>
                        <p><strong>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:</strong> {{ d.finished_at or '‚Äî' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏:</strong></p>
                        <div class="bg-light rounded p-3" style="max-height:200px;overflow-y:auto;white-space:pre-wrap;font-size:.9rem">{{ d.text_preview or '(–Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞)' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°–≤–æ–¥–∫–∞ –æ—à–∏–±–æ–∫ -->
{% if d.error_summary %}
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="table-card">
            <div class="card-header"><i class="fas fa-exclamation-triangle me-2 text-danger"></i>–°–≤–æ–¥–∫–∞ –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫</div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ö–æ–¥ –æ—à–∏–±–∫–∏</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–î–æ–ª—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in d.error_summary %}
                        <tr>
                            <td>
                                {% if item.status == 'sent' %}
                                    <span class="badge bg-success">‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</span>
                                {% elif item.status == 'blocked' %}
                                    <span class="badge bg-warning text-dark">üö´ –ó–∞–±–ª–æ–∫.</span>
                                {% elif item.status == 'failed' %}
                                    <span class="badge bg-danger">‚ùå –û—à–∏–±–∫–∞</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ item.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.error_code %}
                                    <code>{{ item.error_code }}</code>
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>
                                {% if item.error_code == 403 %}
                                    –ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                                {% elif item.error_code == 400 %}
                                    –ù–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (chat not found / –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω)
                                {% elif item.error_code == 429 %}
                                    –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ (rate limit)
                                {% elif item.error_message %}
                                    {{ item.error_message[:100] }}
                                {% elif item.status == 'sent' %}
                                    –£—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
                                {% else %}
                                    –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
                                {% endif %}
                                </small>
                            </td>
                            <td class="fw-bold">{{ item.count }}</td>
                            <td>
                                {% set pct = (item.count / (d.total_users or 1) * 100)|round(1) %}
                                {{ pct }}%
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- –î–∏–∞–≥—Ä–∞–º–º–∞ -->
<div class="row g-3 mb-4">
    <div class="col-lg-5">
        <div class="table-card">
            <div class="card-header"><i class="fas fa-chart-pie me-2"></i>–î–∏–∞–≥—Ä–∞–º–º–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</div>
            <div class="p-3">
                <canvas id="deliveryPie" style="height:260px"></canvas>
            </div>
        </div>
    </div>

    <!-- –û —Ç—Ä–µ–∫–∏–Ω–≥–µ -->
    <div class="col-lg-7">
        <div class="table-card">
            <div class="card-header"><i class="fas fa-info-circle me-2"></i>–ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç –æ—à–∏–±–∫–∏?</div>
            <div class="p-3">
                <table class="table table-sm mb-0">
                    <tr>
                        <td><code>403</code></td>
                        <td><strong>–ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</strong> ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞¬ª –≤ Telegram. –û–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –±—É–¥—É—â–∏—Ö —Ä–∞—Å—Å—ã–ª–æ–∫.</td>
                    </tr>
                    <tr>
                        <td><code>400</code></td>
                        <td><strong>–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</strong> ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–∏–ª –∞–∫–∫–∞—É–Ω—Ç Telegram –∏–ª–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª –±–æ—Ç–∞ (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π chat_id).</td>
                    </tr>
                    <tr>
                        <td><code>429</code></td>
                        <td><strong>Rate limit</strong> ‚Äî Telegram –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–ª –∑–∞–ø—Ä–æ—Å—ã. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É.</td>
                    </tr>
                    <tr>
                        <td><span class="text-muted">–î—Ä—É–≥–∏–µ</span></td>
                        <td>–°–µ—Ç–µ–≤—ã–µ —Å–±–æ–∏, —Ç–∞–π–º–∞—É—Ç—ã, –∏–ª–∏ –æ—à–∏–±–∫–∏ —Ä–∞–∑–º–µ—Ç–∫–∏ HTML –≤ —Ç–µ–∫—Å—Ç–µ.</td>
                    </tr>
                </table>
                <hr>
                <h6 class="mt-3"><i class="fas fa-eye me-2"></i>–ú–æ–∂–Ω–æ –ª–∏ –æ—Ç—Å–ª–µ–¥–∏—Ç—å ¬´–ø—Ä–æ—á–∏—Ç–∞–Ω–æ¬ª?</h6>
                <p class="text-muted mb-0">
                    Telegram Bot API <strong>–Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç</strong> –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—á—Ç–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π. 
                    –û–¥–Ω–∞–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å <strong>–∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º</strong> ‚Äî –∫–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –≤ —Ä–∞—Å—Å—ã–ª–∫–µ 
                    (—á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É newsletter_buttons) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–µ–∫–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥—ã. –î–æ–±–∞–≤–ª—è–π—Ç–µ UTM-–º–µ—Ç–∫–∏ –∫ —Å—Å—ã–ª–∫–∞–º 
                    —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø–µ—Ä–µ—Ö–æ–¥—ã –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ —Å–∞–π—Ç–∞.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Tabs: failed / delivered -->
<ul class="nav nav-tabs mb-3" id="detailTabs">
    <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#tabFailed">
            <i class="fas fa-times-circle text-danger me-1"></i>–ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ ({{ d.failed_users|length if d.failed_users else 0 }})
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#tabSent">
            <i class="fas fa-check-circle text-success me-1"></i>–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ ({{ d.sent_users|length if d.sent_users else 0 }})
        </a>
    </li>
</ul>

<div class="tab-content">
    <!-- Failed users -->
    <div class="tab-pane fade show active" id="tabFailed">
        {% if d.failed_users %}
        <div class="table-card">
            <div class="table-responsive" style="max-height:500px;overflow-y:auto">
                <table class="table table-hover table-sm mb-0">
                    <thead style="position:sticky;top:0;background:#fff">
                        <tr>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>–ò–º—è</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ö–æ–¥</th>
                            <th>–û—à–∏–±–∫–∞</th>
                            <th>–í—Ä–µ–º—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in d.failed_users %}
                        <tr>
                            <td><code>{{ u.user_id }}</code></td>
                            <td>
                                {% if u.username %}
                                    <a href="https://t.me/{{ u.username }}" target="_blank">@{{ u.username }}</a>
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>{{ u.first_name or '‚Äî' }}</td>
                            <td>
                                {% if u.status == 'blocked' %}
                                    <span class="badge bg-warning text-dark">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                                {% else %}
                                    <span class="badge bg-danger">‚ùå –û—à–∏–±–∫–∞</span>
                                {% endif %}
                            </td>
                            <td><code>{{ u.error_code or '‚Äî' }}</code></td>
                            <td><small>{{ (u.error_message or '‚Äî')[:80] }}</small></td>
                            <td><small>{{ u.delivered_at[:19] if u.delivered_at else '‚Äî' }}</small></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>
            –û—Ç–ª–∏—á–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ ‚Äî –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—ã–ª–∏ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã!
        </div>
        {% endif %}
    </div>

    <!-- Sent users -->
    <div class="tab-pane fade" id="tabSent">
        {% if d.sent_users %}
        <div class="table-card">
            <div class="table-responsive" style="max-height:500px;overflow-y:auto">
                <table class="table table-hover table-sm mb-0">
                    <thead style="position:sticky;top:0;background:#fff">
                        <tr>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>–ò–º—è</th>
                            <th>–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in d.sent_users %}
                        <tr>
                            <td><code>{{ u.user_id }}</code></td>
                            <td>
                                {% if u.username %}
                                    <a href="https://t.me/{{ u.username }}" target="_blank">@{{ u.username }}</a>
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>{{ u.first_name or '‚Äî' }}</td>
                            <td><small>{{ u.delivered_at[:19] if u.delivered_at else '‚Äî' }}</small></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Pie chart
const sentC = {{ d.sent_count or 0 }};
const failedC = {{ d.failed_count or 0 }};
const blockedC = {{ d.blocked_count or 0 }};
const totalC = sentC + failedC + blockedC;

if(totalC > 0) {
    new Chart(document.getElementById('deliveryPie'), {
        type: 'doughnut',
        data: {
            labels: [`–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ (${sentC})`, `–û—à–∏–±–∫–∏ (${failedC})`, `–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã (${blockedC})`],
            datasets: [{
                data: [sentC, failedC, blockedC],
                backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                borderWidth: 0,
                cutout: '60%'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.label}: ${ctx.parsed} (${((ctx.parsed/totalC)*100).toFixed(1)}%)`
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}
