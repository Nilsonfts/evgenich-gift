{% extends "full/base.html" %}
{% block title %}–î–∞—à–±–æ—Ä–¥{% endblock %}

{% block content %}
<div class="page-h">
    <h2>üìä –î–∞—à–±–æ—Ä–¥</h2>
    <p>–°–º–µ–Ω–∞ {{ shift_start }} ‚Äì {{ shift_end }} ‚Ä¢ {% if db_ok %}<span class="text-success">–ë–î –ø–æ–¥–∫–ª—é—á–µ–Ω–∞{% if use_postgres %} (PostgreSQL){% endif %}</span>{% else %}<span class="text-danger">–ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</span>{% endif %}</p>
</div>

<!-- Stat cards -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</small>
                    <h3>{{ total_users }}</h3>
                </div>
                <div class="icon" style="background:linear-gradient(135deg,#6366f1,#8b5cf6)"><i class="fas fa-users"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small>–ê–∫—Ç–∏–≤–Ω—ã—Ö (—Ä–∞—Å—Å—ã–ª–∫–∏)</small>
                    <h3>{{ active_users }}</h3>
                </div>
                <div class="icon" style="background:linear-gradient(135deg,#10b981,#059669)"><i class="fas fa-check-circle"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞</small>
                    <h3>{{ blocked_users }}</h3>
                </div>
                <div class="icon" style="background:linear-gradient(135deg,#ef4444,#dc2626)"><i class="fas fa-ban"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small>–ù–æ–≤—ã—Ö –∑–∞ 30 –¥–Ω–µ–π</small>
                    <h3>{{ recent_30d }}</h3>
                </div>
                <div class="icon" style="background:linear-gradient(135deg,#f59e0b,#d97706)"><i class="fas fa-user-plus"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- Shift cards -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small>–ö—É–ø–æ–Ω–æ–≤ –≤—ã–¥–∞–Ω–æ (—Å–º–µ–Ω–∞)</small>
                    <h3 style="color:#6366f1">{{ issued_today }}</h3>
                </div>
                <div class="icon" style="background:linear-gradient(135deg,#6366f1,#818cf8)"><i class="fas fa-ticket-alt"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small>–ù–∞—Å—Ç–æ–µ–∫ –ø–æ–≥–∞—à–µ–Ω–æ (—Å–º–µ–Ω–∞)</small>
                    <h3 style="color:#10b981">{{ redeemed_today }}</h3>
                </div>
                <div class="icon" style="background:linear-gradient(135deg,#10b981,#34d399)"><i class="fas fa-glass-cheers"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small>–ö–æ–Ω–≤–µ—Ä—Å–∏—è</small>
                    <h3 style="color:#f59e0b">{{ conversion }}%</h3>
                </div>
                <div class="icon" style="background:linear-gradient(135deg,#f59e0b,#fbbf24)"><i class="fas fa-percentage"></i></div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <!-- Staff performance -->
    <div class="col-lg-5">
        <div class="table-card">
            <div class="card-header"><i class="fas fa-trophy me-2"></i>–ü–µ—Ä—Å–æ–Ω–∞–ª –∑–∞ —Å–º–µ–Ω—É</div>
            <div class="p-3">
                {% if staff_stats %}
                    {% for position, staff_list in staff_stats.items() %}
                    <h6 class="text-muted mb-2">{{ position }}</h6>
                    <table class="table table-sm table-hover mb-3">
                        <thead><tr><th>–ò–º—è</th><th class="text-end">–ü—Ä–∏–≤–ª–µ—á–µ–Ω–æ</th></tr></thead>
                        <tbody>
                        {% for s in staff_list|sort(attribute='brought', reverse=true) %}
                        <tr>
                            <td>
                                {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% endif %}
                                {{ s.name or s.full_name or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}
                            </td>
                            <td class="text-end fw-bold">{{ s.brought or s.count or 0 }}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent activity -->
    <div class="col-lg-7">
        <div class="table-card">
            <div class="card-header"><i class="fas fa-history me-2"></i>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</div>
            <div style="max-height:400px;overflow-y:auto">
                <table class="table table-sm table-hover">
                    <thead><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–í—Ä–µ–º—è</th></tr></thead>
                    <tbody>
                    {% for a in recent_activities[:15] %}
                    <tr>
                        <td>
                            <a href="/users/{{ a.user_id or a.get('user_id','') }}" class="text-decoration-none">
                                {{ a.first_name or a.username or a.user_id or '‚Äî' }}
                            </a>
                        </td>
                        <td>
                            {% if a.status == 'registered' %}<span class="badge bg-info">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
                            {% elif a.status == 'issued' %}<span class="badge bg-warning text-dark">–ö—É–ø–æ–Ω</span>
                            {% elif a.status == 'redeemed' %}<span class="badge bg-success">–ü–æ–≥–∞—à–µ–Ω–æ</span>
                            {% else %}<span class="badge bg-secondary">{{ a.status or '‚Äî' }}</span>{% endif %}
                        </td>
                        <td class="text-muted" style="font-size:.8rem">{{ a.time or a.signup_date or '‚Äî' }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center text-muted py-4">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto refresh stats every 60 sec
setInterval(()=>{
    fetch('/api/stats').then(r=>r.json()).then(d=>{
        // Could update counters via DOM, skip for simplicity
    }).catch(()=>{});
}, 60000);
</script>
{% endblock %}
