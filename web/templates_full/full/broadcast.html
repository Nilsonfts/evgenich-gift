{% extends "full/base.html" %}
{% block title %}–†–∞—Å—Å—ã–ª–∫–∏{% endblock %}

{% block content %}
<div class="page-h">
    <h2><i class="fas fa-bullhorn me-2"></i>–†–∞—Å—Å—ã–ª–∫–∏</h2>
    <p>–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏</p>
    <a href="/broadcast/history" class="btn btn-outline-primary btn-sm ms-auto">
        <i class="fas fa-history me-1"></i>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫
    </a>
</div>

<!-- Stats cards -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div><small>–í—Å–µ–≥–æ –≤ –±–∞–∑–µ</small><h3>{{ stats.total or 0 }}</h3></div>
                <div class="icon" style="background:linear-gradient(135deg,#6366f1,#8b5cf6)"><i class="fas fa-users"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div><small>–ü–æ–ª—É—á–∞—Ç —Ä–∞—Å—Å—ã–ª–∫—É</small><h3 style="color:#10b981">{{ stats.active or 0 }}</h3></div>
                <div class="icon" style="background:linear-gradient(135deg,#10b981,#059669)"><i class="fas fa-paper-plane"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div><small>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞</small><h3 style="color:#ef4444">{{ stats.blocked or 0 }}</h3></div>
                <div class="icon" style="background:linear-gradient(135deg,#ef4444,#dc2626)"><i class="fas fa-ban"></i></div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="stat-card">
            <div class="d-flex align-items-center justify-content-between">
                <div><small>–ù–æ–≤—ã—Ö –∑–∞ 30 –¥–Ω–µ–π</small><h3 style="color:#3b82f6">{{ stats.recent_30d or 0 }}</h3></div>
                <div class="icon" style="background:linear-gradient(135deg,#3b82f6,#2563eb)"><i class="fas fa-user-plus"></i></div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <!-- Send broadcast form -->
    <div class="col-lg-7">
        <div class="table-card">
            <div class="card-header"><i class="fas fa-paper-plane me-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</div>
            <div class="p-3">
                <form method="POST" action="/broadcast/send" id="broadcastForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è <span class="text-danger">*</span></label>
                        <textarea name="text" class="form-control" rows="6" required
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏...&#10;&#10;–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML:&#10;&lt;b&gt;–∂–∏—Ä–Ω—ã–π&lt;/b&gt;&#10;&lt;i&gt;–∫—É—Ä—Å–∏–≤&lt;/i&gt;&#10;&lt;a href=&quot;url&quot;&gt;—Å—Å—ã–ª–∫–∞&lt;/a&gt;"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="fas fa-link me-1"></i>–ö–Ω–æ–ø–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <div class="row g-2">
                            <div class="col-5">
                                <input type="text" name="btn_text" class="form-control" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" maxlength="40">
                            </div>
                            <div class="col-7">
                                <input type="url" name="btn_url" class="form-control" placeholder="https://...">
                            </div>
                        </div>
                        <small class="text-muted">–ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è ‚Äî –∫ —Å–æ–æ–±—â–µ–Ω–∏—é –¥–æ–±–∞–≤–∏—Ç—Å—è –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∞</small>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        –†–∞—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ <b>{{ stats.active or 0 }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</b>. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100"
                            onclick="return confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É {{ stats.active or 0 }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?')">
                        <i class="fas fa-paper-plane me-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                    </button>
                </form>

                <!-- Progress -->
                <div id="broadcastProgress" class="mt-3" style="display:none">
                    <div class="d-flex align-items-center mb-2">
                        <div class="spinner-border text-primary me-3 spinner-border-sm"></div>
                        <span class="fw-bold" id="bcastText">–û—Ç–ø—Ä–∞–≤–∫–∞...</span>
                    </div>
                    <div class="progress mb-2" style="height:6px">
                        <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" id="bcastBar" style="width:0%"></div>
                    </div>
                    <small class="text-muted" id="bcastDetail"></small>
                </div>

                <!-- Result -->
                <div id="broadcastResult" class="mt-3" style="display:none"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <!-- Chart -->
        <div class="table-card mb-3">
            <div class="card-header"><i class="fas fa-chart-pie me-2"></i>–î–æ—Å—Ç–∞–≤–ª—è–µ–º–æ—Å—Ç—å</div>
            <div class="p-3">
                <canvas id="deliveryChart" style="height:220px"></canvas>
            </div>
        </div>

        <!-- Via bot -->
        <div class="table-card">
            <div class="card-header"><i class="fab fa-telegram me-2"></i>–ß–µ—Ä–µ–∑ –±–æ—Ç–∞ (—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ)</div>
            <div class="p-3">
                <p class="text-muted mb-2">–î–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –º–µ–¥–∏–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:</p>
                <ol style="font-size:.9rem" class="mb-0">
                    <li>–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram</li>
                    <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ <code>/broadcast</code></li>
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø ‚Üí –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Delivery chart
const active={{stats.active or 0}}, blocked={{stats.blocked or 0}}, total={{stats.total or 0}};
if(total > 0){
    new Chart(document.getElementById('deliveryChart'),{
        type:'doughnut',
        data:{
            labels:[`–î–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–µ (${active})`,`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ (${blocked})`],
            datasets:[{data:[active,blocked],backgroundColor:['#10b981','#ef4444'],borderWidth:0,cutout:'65%'}]
        },
        options:{responsive:true,plugins:{legend:{position:'bottom'},
            tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.parsed} (${((ctx.parsed/total)*100).toFixed(1)}%)`}}
        }}
    });
}

// Broadcast poll
let bcastPoll = null;
document.getElementById('broadcastForm').addEventListener('submit', function(){
    setTimeout(()=>{
        document.getElementById('broadcastProgress').style.display='block';
        document.getElementById('broadcastResult').style.display='none';
        bcastPoll = setInterval(pollBcast, 2000);
    }, 500);
});

function pollBcast(){
    fetch('/api/broadcast/status').then(r=>r.json()).then(d=>{
        if(d.running){
            document.getElementById('bcastDetail').textContent = d.progress || '...';
            const m = (d.progress||'').match(/(\d+)\/(\d+)/);
            if(m){
                const pct = Math.round(parseInt(m[1])/parseInt(m[2])*100);
                document.getElementById('bcastBar').style.width = pct+'%';
            }
        }
        if(d.done && d.result){
            clearInterval(bcastPoll);
            document.getElementById('broadcastProgress').style.display='none';
            const res = document.getElementById('broadcastResult');
            res.style.display='block';
            const r = d.result;
            if(r.error){
                res.innerHTML=`<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i>${r.error}</div>`;
            } else {
                const rate = r.total>0 ? ((r.sent/r.total)*100).toFixed(1) : 0;
                let detailLink = '';
                if(r.broadcast_id) {
                    detailLink = `<a href="/broadcast/details/${r.broadcast_id}" class="btn btn-sm btn-outline-primary mt-2"><i class="fas fa-eye me-1"></i>–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ—à–∏–±–æ–∫</a>`;
                }
                res.innerHTML=`
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle me-2"></i>–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h5>
                        <table class="table table-sm mb-0 mt-2">
                            <tr><td>–í—Å–µ–≥–æ</td><td class="fw-bold">${r.total}</td></tr>
                            <tr><td>‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</td><td class="fw-bold text-success">${r.sent}</td></tr>
                            <tr><td>‚ùå –û—à–∏–±–æ–∫</td><td class="text-danger">${r.failed}</td></tr>
                            <tr><td>üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏</td><td class="text-warning">${r.blocked}</td></tr>
                            <tr><td>üìä –î–æ—Å—Ç–∞–≤–ª—è–µ–º–æ—Å—Ç—å</td><td class="fw-bold">${rate}%</td></tr>
                        </table>
                        ${detailLink}
                    </div>`;
            }
        }
    }).catch(()=>{});
}
</script>
{% endblock %}
