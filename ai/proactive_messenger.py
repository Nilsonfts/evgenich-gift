# /ai/proactive_messenger.py
"""
–ú–æ–¥—É–ª—å –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö
–ë–æ—Ç —Ä–µ–¥–∫–æ, –Ω–æ –º–µ—Ç–∫–æ –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä
"""

import random
import logging
from datetime import datetime, timedelta
from typing import Optional, Dict

logger = logging.getLogger("evgenich_ai")


class ProactiveMessenger:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –±–æ—Ç–∞"""
    
    def __init__(self):
        # –®–∞–Ω—Å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (5%)
        self.response_chance = 0.05
        
        # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (30 –º–∏–Ω—É—Ç)
        self.cooldown_minutes = 30
        
        # –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —á–∞—Ç–∞–º
        self.last_proactive = {}
        
        # –¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —Ä–µ–∞–∫—Ü–∏–∏
        self.triggers = {
            "photos_videos": {
                "keywords": [
                    "—Ñ–æ—Ç–æ", "—Ñ–æ—Ç–∫–∞", "—Ñ–æ—Ç–∫–∏", "—Å–Ω–∏–º–æ–∫", "—Å–µ–ª—Ñ–∏",
                    "–≤–∏–¥–µ–æ", "–≤–∏–¥–æ—Å", "—Ä–æ–ª–∏–∫", "—Å—Ç–æ—Ä–∏—Å", "stories",
                    "–∑–∞–ø–∏—Å—å", "–∑–∞–ø–∏—Å–∞–ª", "—Å—Ñ–æ—Ç–∫–∞–ª",
                ],
                "responses": [
                    "–û, –∫–ª–∞—Å—Å–Ω–æ! üì∏ –ö–∏–¥–∞–π—Ç–µ –±–æ–ª—å—à–µ —Ñ–æ—Ç–æ–∫ –∏–∑ –±–∞—Ä–∞, –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å! üòä",
                    "–û–≥–æ! –ü–æ–∫–∞–∂–∏—Ç–µ —á—Ç–æ —Ç–∞–º —É –≤–∞—Å —Ç–≤–æ—Ä–∏—Ç—Å—è! üì∏",
                    "–•–µ—Ö, –≤–∏–¥–æ—Å–∏–∫–∏ –∏–∑ –±–∞—Ä–∞ –≤—Å–µ–≥–¥–∞ —Ç–æ–ø! üé• –î–µ–ª–∏—Ç–µ—Å—å!",
                    "–ô–æ—É! üòÑ –°–∫–∏–¥—ã–≤–∞–π—Ç–µ —Ñ–æ—Ç–æ—á–∫–∏/–≤–∏–¥–æ—Å–∏–∫–∏ - –≤—Å–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ!",
                ],
                "chance": 0.3,  # 30% –ø—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ
            },
            "in_bar": {
                "keywords": [
                    "–≤ –±–∞—Ä–µ", "—Å–µ–π—á–∞—Å –∑–¥–µ—Å—å", "–º—ã —Ç—É—Ç", "–ø—Ä–∏—à–ª–∏", "–Ω–∞ –º–µ—Å—Ç–µ",
                    "—É–∂–µ –≤ –µ–≤–≥–µ–Ω–∏—á–µ", "–≤ –µ–≤–≥–µ–Ω–∏—á–µ", "—Å–∏–¥–∏–º", "—Ç—É—Å–∏–º",
                    "–∑–∞—à–ª–∏", "–ø—Ä–∏—à–µ–ª", "–ø—Ä–∏—à–ª–∞", "–Ω–∞—Ö–æ–¥–∏–º—Å—è",
                ],
                "responses": [
                    "–û! –í—ã –≤ –±–∞—Ä–µ? üòä –ö–∞–∫ —Ç–∞–º –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞?",
                    "–ö—Ä—É—Ç–æ! ü•É –ö–∞–∫ –≤–∞–º —Ç–∞–º?",
                    "–û–≥–æ, —É–∂–µ –Ω–∞ –º–µ—Å—Ç–µ! üéâ –ß—Ç–æ –∑–∞–∫–∞–∑–∞–ª–∏?",
                    "–ö–ª–∞—Å—Å! –ü–æ—Ç–æ–º —Ä–∞—Å—Å–∫–∞–∂–µ—Ç–µ –∫–∞–∫ –±—ã–ª–æ üòä",
                ],
                "chance": 0.2,  # 20% –µ—Å–ª–∏ –≥–æ—Å—Ç–∏ –≤ –±–∞—Ä–µ
            },
            "good_vibes": {
                "keywords": [
                    "–∫—Ä—É—Ç–æ", "–∫–ª–∞—Å—Å", "—Å—É–ø–µ—Ä", "–æ—Ç–ª–∏—á–Ω–æ", "–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ",
                    "–æ–≥–æ–Ω—å", "—Ç–æ–ø", "–∫–∞–π—Ñ", "–≤–µ—Å–µ–ª–æ", "–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞",
                    "–ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å", "–∫–ª–∞—Å—Å–Ω–æ –ø—Ä–æ–≤–µ–ª–∏",
                ],
                "responses": [
                    "–†–∞–¥ —Å–ª—ã—à–∞—Ç—å! üòä",
                    "–í–æ—Ç —ç—Ç–æ –∫–∞–π—Ñ! üéâ",
                    "–ê–≥–∞, —É –Ω–∞—Å –≤—Å–µ–≥–¥–∞ —Ç–∞–∫! üòÑ",
                    "–ö—Ä—É—Ç–æ —á—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å! üëç",
                ],
                "chance": 0.15,  # 15% –Ω–∞ –ø–æ–∑–∏—Ç–∏–≤
            },
            "music_karaoke": {
                "keywords": [
                    "–∫–∞—Ä–∞–æ–∫–µ", "–ø–µ—Ç—å", "—Å–ø–µ–ª–∏", "–ø–µ—Å–Ω—é", "–ø–µ—Å–Ω–∏",
                    "–º—É–∑—ã–∫–∞", "–º—É–∑–æ–Ω", "—Ç—Ä–µ–∫", "—Ö–∏—Ç", "–∏–≥—Ä–∞–µ—Ç",
                    "—Ç–∞–Ω—Ü—ã", "—Ç–∞–Ω—Ü–µ–≤–∞–ª–∏", "–ø–æ—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å",
                ],
                "responses": [
                    "–û, –∫–∞—Ä–∞–æ–∫–µ –ø–æ—à–ª–æ! üé§ –ß—Ç–æ –ø–µ–ª–∏?",
                    "–¢–∞–Ω—Ü—ã-—à–º–∞–Ω—Ü—ã! üíÉüï∫",
                    "–ú—É–∑–æ–Ω –∫–∞—á–∞–µ—Ç? üé∂",
                    "–ö–∞—Ä–∞–æ–∫–µ —É –Ω–∞—Å –≤—Å–µ–≥–¥–∞ –∑–∞–∂–∏–≥–∞–µ—Ç! üé§",
                ],
                "chance": 0.25,  # 25% –ø—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –º—É–∑—ã–∫–∏
            },
            "drinks": {
                "keywords": [
                    "–Ω–∞—Å—Ç–æ–π–∫–∞", "–Ω–∞—Å—Ç–æ–π–∫–∏", "—Ö—É–±–∞-–±—É–±–∞", "–ø–ª–æ–º–±–∏—Ä",
                    "–≤—ã–ø–∏–ª–∏", "–ø—å–µ–º", "–∑–∞–∫–∞–∑–∞–ª–∏", "–∫–æ–∫—Ç–µ–π–ª—å",
                    "—à–æ—Ç", "—Ä—é–º–∫–∞", "—Å—Ç–æ–ø–∫–∞",
                ],
                "responses": [
                    "–•—É–±–∞-–ë—É–±–∞ —Ç–æ–ø! ü•É",
                    "–û, —á—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª–∏?",
                    "–ù–∞—Å—Ç–æ–π–∫–∏ –Ω–∞—à–∏ - –æ–≥–æ–Ω—å! üî•",
                    "–í–∫—É—Å–Ω–æ? üòä",
                ],
                "chance": 0.2,  # 20% –ø—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –Ω–∞–ø–∏—Ç–∫–æ–≤
            },
        }
    
    def should_respond(self, message: str, chat_id: int) -> Optional[str]:
        """
        –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω—É–∂–Ω–æ –ª–∏ –±–æ—Ç—É –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å
        
        Args:
            message: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            chat_id: ID —á–∞—Ç–∞
            
        Returns:
            None –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å
            str —Å —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        """
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º cooldown
        if not self._check_cooldown(chat_id):
            return None
        
        message_lower = message.lower()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
        for trigger_name, config in self.triggers.items():
            keywords = config["keywords"]
            responses = config["responses"]
            chance = config["chance"]
            
            # –ï—Å—Ç—å –ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞?
            if any(keyword in message_lower for keyword in keywords):
                # –ë—Ä–æ—Å–∞–µ–º –∫–æ—Å—Ç—å
                if random.random() < chance:
                    # –û–±–Ω–æ–≤–ª—è–µ–º cooldown
                    self._update_cooldown(chat_id)
                    
                    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –æ—Ç–≤–µ—Ç
                    response = random.choice(responses)
                    logger.info(f"üé≤ –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ —á–∞—Ç–µ {chat_id}: trigger={trigger_name}")
                    return response
        
        # –°–ª—É—á–∞–π–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—á–µ–Ω—å —Ä–µ–¥–∫–æ)
        if random.random() < self.response_chance:
            generic_responses = [
                "–•–∞—Ö üòÑ",
                "–ê–≥–∞ üëç",
                "–¢–æ—á–Ω–æ!",
                "–ù—É –¥–∞ üòä",
                "–•–µ—Ö",
            ]
            
            self._update_cooldown(chat_id)
            response = random.choice(generic_responses)
            logger.info(f"üé≤ –°–ª—É—á–∞–π–Ω—ã–π –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ —á–∞—Ç–µ {chat_id}")
            return response
        
        return None
    
    def _check_cooldown(self, chat_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—à–µ–ª –ª–∏ cooldown"""
        if chat_id not in self.last_proactive:
            return True
        
        last_time = self.last_proactive[chat_id]
        elapsed = datetime.now() - last_time
        
        return elapsed > timedelta(minutes=self.cooldown_minutes)
    
    def _update_cooldown(self, chat_id: int):
        """–û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        self.last_proactive[chat_id] = datetime.now()
    
    def get_stats(self) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        return {
            "response_chance": self.response_chance,
            "cooldown_minutes": self.cooldown_minutes,
            "active_chats": len(self.last_proactive),
            "triggers": len(self.triggers),
        }


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
proactive_messenger = ProactiveMessenger()
