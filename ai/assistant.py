# /ai/assistant.py
"""
AI-–ª–æ–≥–∏–∫–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI.
"""
import logging
from ai.knowledge import find_relevant_info
from openai import OpenAI
from core.config import OPENAI_API_KEY

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞
openai_client = None
if OPENAI_API_KEY:
    try:
        openai_client = OpenAI(api_key=OPENAI_API_KEY)
        logging.info("OpenAI –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenAI –∫–ª–∏–µ–Ω—Ç–∞: {e}")
        openai_client = None
else:
    logging.warning("OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. AI —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.")

logger = logging.getLogger("evgenich_ai")

# --- PUBLIC API ---
def get_ai_recommendation(
    user_query: str,
    conversation_history: list[dict[str, str]] | None = None,
    *,
    daily_updates: dict[str, str] | None = None,
    user_concept: str = "evgenich",
    user_type: str = "regular",
    bar_context: str = "",
    emotion: dict = None,
    preferences: str = "",
    is_group_chat: bool = False,
    model: str = "gpt-4o",
    temperature: float = 0.9,
    max_tokens: int = 120,  # –£–º–µ–Ω—å—à–∏–ª–∏ –¥–ª—è –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
) -> str:
    logger.info("–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å: %s", user_query)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞
    if not openai_client:
        logger.error("OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        return "–¢–æ–≤–∞—Ä–∏—â, –º–æ–π –º—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ—Å–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AI."
    
    relevant_context = find_relevant_info(user_query)
    logger.info("–ù–∞–π–¥–µ–Ω–Ω—ã–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: %s", relevant_context)
    
    updates_string = f"–°–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è: {daily_updates.get('special', '–Ω–µ—Ç')}. –í —Å—Ç–æ–ø‚Äë–ª–∏—Å—Ç–µ: {daily_updates.get('stop-list', '–Ω–∏—á–µ–≥–æ')}" if daily_updates else "–Ω–µ—Ç –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
    
    # –°–æ–∑–¥–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–∞—Ä–µ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    extended_context = f"{updates_string}\n"
    if bar_context:
        extended_context += f"\n–ö–æ–Ω—Ç–µ–∫—Å—Ç –±–∞—Ä–∞: {bar_context}\n"
    
    # –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –≥–æ—Å—Ç—è
    user_type_context = ""
    if user_type == "new":
        user_type_context = "–≠—Ç–æ –Ω–æ–≤—ã–π –≥–æ—Å—Ç—å, —Ä–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –±–∞—Ä–µ, –±—É–¥—å –æ—Å–æ–±–µ–Ω–Ω–æ –≥–æ—Å—Ç–µ–ø—Ä–∏–∏–º–Ω—ã–º."
    elif user_type == "regular":
        user_type_context = "–≠—Ç–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –≥–æ—Å—Ç—å, –æ–±—â–∞–π—Å—è –∫–∞–∫ —Å–æ —Å—Ç–∞—Ä—ã–º –∑–Ω–∞–∫–æ–º—ã–º."
    elif user_type == "vip":
        user_type_context = "–≠—Ç–æ VIP-–≥–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä—ã–π —á–∞—Å—Ç–æ —É –Ω–∞—Å –±—ã–≤–∞–µ—Ç! –û—Å–æ–±–æ–µ —É–≤–∞–∂–µ–Ω–∏–µ –∏ –≤–Ω–∏–º–∞–Ω–∏–µ."
    
    if user_type_context:
        extended_context += f"\n{user_type_context}\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if preferences:
        extended_context += f"\n{preferences}\n"
    
    # –ï—Å–ª–∏ —ç—Ç–æ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç –∏ –≤–æ–ø—Ä–æ—Å –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ - –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É
    if is_group_chat:
        extended_context += (
            "\nüîî –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –≠–¢–û –ì–†–£–ü–ü–û–í–û–ô –ß–ê–¢!\n\n"
            "üì± –û –ß–ê–¢–ï:\n"
            "–≠—Ç–æ —á–∞—Ç –¥–ª—è –≥–æ—Å—Ç–µ–π –ï–≤–≥–µ–Ω–∏—á–∞ - –∑–¥–µ—Å—å –æ–±—â–∞–µ–º—Å—è, –¥–µ–ª–∏–º—Å—è –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏, —É–∑–Ω–∞–µ–º –Ω–æ–≤–æ—Å—Ç–∏ –±–∞—Ä–∞.\n"
            "–û–±—ä—è—Å–Ω–∏ —Ç–µ–ø–ª–æ –∏ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏: ¬´–≠—Ç–æ –Ω–∞—à –æ–±—â–∏–π —á–∞—Ç, —Ç–æ–≤–∞—Ä–∏—â! üòä –ó–¥–µ—Å—å –º—ã –≤—Å–µ —Ç—É—Å—É–µ–º—Å—è - –¥–µ–ª–∏–º—Å—è —Ñ–æ—Ç–∫–∞–º–∏ —Å –≤–µ—á–µ—Ä–∏–Ω–æ–∫, –æ–±—Å—É–∂–¥–∞–µ–º –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç–æ–π–∫–∏, —É–∑–Ω–∞–µ–º –ø—Ä–æ —Å–æ–±—ã—Ç–∏—è. –†–∞–¥ —á—Ç–æ —Ç—ã —Å –Ω–∞–º–∏!¬ª\n\n"
            "üç∑ –ï–°–õ–ò –ì–û–°–¢–¨ –°–ü–†–ê–®–ò–í–ê–ï–¢ –ü–†–û –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ï - –ë–£–î–¨ –ó–ê–ë–û–¢–õ–ò–í–´–ú –ü–û–ú–û–©–ù–ò–ö–û–ú:\n\n"
            "–í–ê–†–ò–ê–ù–¢ 1 - –ì–æ—Å—Ç—å –≥–æ–≤–æ—Ä–∏—Ç —á—Ç–æ –£–ñ–ï –û–°–¢–ê–í–ò–õ –ó–ê–Ø–í–ö–£ –ù–ê –°–ê–ô–¢–ï:\n"
            "‚Üí –ü–æ—Ö–≤–∞–ª–∏ –∏ —É—Å–ø–æ–∫–æ–π: ¬´–ú–æ–ª–æ–¥–µ—Ü, —á—Ç–æ –æ—Å—Ç–∞–≤–∏–ª –∑–∞—è–≤–∫—É! üëç –î–µ–≤—á–æ–Ω–∫–∏ –∏–∑ –æ—Ç–¥–µ–ª–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —É–∂–µ –≤–∏–¥—è—Ç –µ—ë –∏ —Å–∫–æ—Ä–æ –Ω–∞–ø–∏—à—É—Ç —Ç–µ–±–µ. –û–±—ã—á–Ω–æ –æ—Ç–≤–µ—á–∞—é—Ç –±—ã—Å—Ç—Ä–æ, –º–∞–∫—Å–∏–º—É–º 30 –º–∏–Ω—É—Ç. –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π! üòä –ê –Ω–∞ –∫–∞–∫–æ–π –±–∞—Ä —Ö–æ—á–µ—à—å - –ù–µ–≤—Å–∫–∏–π –∏–ª–∏ –†—É–±–∏–Ω—à—Ç–µ–π–Ω–∞?¬ª\n\n"
            "–í–ê–†–ò–ê–ù–¢ 2 - –ì–æ—Å—Ç—å –°–ü–†–ê–®–ò–í–ê–ï–¢ –ö–ê–ö –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨ (–Ω–µ –≥–æ–≤–æ—Ä–∏—Ç —á—Ç–æ —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª –∑–∞—è–≤–∫—É):\n"
            "‚Üí –ü–æ–º–æ–≥–∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –ö–û–†–û–¢–ö–û:\n"
            "   ¬´–¢—ã —É–∂–µ –∑–∞–ø–æ–ª–Ω—è–ª —Ñ–æ—Ä–º—É –Ω–∞ —Å–∞–π—Ç–µ spb.evgenich.bar? üòä¬ª\n"
            "‚Üí –ï—Å–ª–∏ –≥–æ—Å—Ç—å –æ—Ç–≤–µ—á–∞–µ—Ç –ù–ï–¢:\n"
            "   ¬´–°–º–æ—Ç—Ä–∏ –≤–≤–µ—Ä—Ö—É —á–∞—Ç–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ üìå –¢–∞–º –∫–Ω–æ–ø–∫–∞ –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨. –ñ–º–∏ –∏ –∑–∞–ø–æ–ª–Ω—è–π! üòâ¬ª\n"
            "‚Üí –ï—Å–ª–∏ –≥–æ—Å—Ç—å –æ—Ç–≤–µ—á–∞–µ—Ç –î–ê (—É–∂–µ –∑–∞–ø–æ–ª–Ω—è–ª):\n"
            "   ¬´–û—Ç–ª–∏—á–Ω–æ! üëç –î–µ–≤—á–æ–Ω–∫–∏ —Å–∫–æ—Ä–æ –Ω–∞–ø–∏—à—É—Ç, –º–∞–∫—Å–∏–º—É–º 30 –º–∏–Ω—É—Ç¬ª\n\n"
            "–í–ê–†–ò–ê–ù–¢ 3 - –ì–æ—Å—Ç—å –ü–ï–†–ï–°–ü–†–ê–®–ò–í–ê–ï–¢/–í–û–õ–ù–£–ï–¢–°–Ø/–°–û–ú–ù–ï–í–ê–ï–¢–°–Ø:\n"
            "‚Üí –ë—É–¥—å —ç–º–ø–∞—Ç–∏—á–Ω—ã–º: \n"
            "   ¬´–≠–π, –≤—Å–µ –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–æ! üòä –ü–æ–Ω–∏–º–∞—é, —á—Ç–æ –∂–¥–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ –≤–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ. –î–µ–≤—á–æ–Ω–∫–∏ —Ç–æ—á–Ω–æ –≤–∏–¥—è—Ç —Ç–≤–æ—é –∑–∞—è–≤–∫—É –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—Ç—è—Ç. –û–Ω–∏ –º–æ–ª–æ–¥—Ü—ã, –Ω–∏–∫–æ–≥–æ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç!\"\n"
            "   \"–ï—Å–ª–∏ –≤–¥—Ä—É–≥ –æ—á–µ–Ω—å —Å—Ä–æ—á–Ω–æ –∏–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã - –º–æ–∂–µ—à—å –ø–æ–∑–≤–æ–Ω–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é: +7 (812) 317-23-53 üìû –¢–∞–º —Ç–µ–±–µ –≤—Å—ë —Ä–∞—Å—Å–∫–∞–∂—É—Ç –∏ –ø–æ–º–æ–≥—É—Ç!¬ª\n\n"
            "–í–ê–†–ò–ê–ù–¢ 4 - –ì–æ—Å—Ç—å –ù–ï –ü–û–ù–ò–ú–ê–ï–¢ –ì–î–ï –ó–ê–ö–†–ï–ü:\n"
            "‚Üí –ü–æ–º–æ–≥–∏ –Ω–∞–π—Ç–∏: ¬´–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —ç—Ç–æ —Å–∞–º–æ–µ –≤–µ—Ä—Ö–Ω–µ–µ –≤ —á–∞—Ç–µ üëÜ –ü—Ä–æ–∫—Ä—É—Ç–∏ –≤ —Å–∞–º—ã–π –≤–µ—Ä—Ö, —Ç–∞–º –±—É–¥–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ –∑–Ω–∞—á–∫–æ–º üìå –∏ –∫–Ω–æ–ø–∫–æ–π. –ù–∞—à–µ–ª? üòä¬ª\n\n"
            "‚ùå –ù–ï –≥–æ–≤–æ—Ä–∏ '[START_BOOKING_FLOW]' –≤ –≥—Ä—É–ø–ø–µ - —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–∫–µ!\n"
            "‚úÖ –ë—É–¥—å —Ç–µ—Ä–ø–µ–ª–∏–≤—ã–º –ø–æ–º–æ—â–Ω–∏–∫–æ–º! –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã. –ü–æ–º–æ–≥–∞–π —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è.\n"
        )
    
    # –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ —ç–º–æ—Ü–∏–∏
    if emotion and emotion.get('emotion') != 'neutral':
        emotion_name = emotion['emotion']
        emotion_context = ""
        if emotion_name == 'joy':
            emotion_context = "–ì–æ—Å—Ç—å –≤ –æ—Ç–ª–∏—á–Ω–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏! –ü–æ–¥–¥–µ—Ä–∂–∏ –ø–æ–∑–∏—Ç–∏–≤."
        elif emotion_name == 'sadness':
            emotion_context = "–ì–æ—Å—Ç—å –≥—Ä—É—Å—Ç–∏—Ç. –ë—É–¥—å –¥–µ–ª–∏–∫–∞—Ç–Ω—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º."
        elif emotion_name == 'anger':
            emotion_context = "–ì–æ—Å—Ç—å –Ω–µ–¥–æ–≤–æ–ª–µ–Ω. –ë—É–¥—å —Ç–µ—Ä–ø–µ–ª–∏–≤—ã–º –∏ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –ø–æ–º–æ—á—å."
        elif emotion_name == 'surprise':
            emotion_context = "–ì–æ—Å—Ç—å —É–¥–∏–≤–ª–µ–Ω. –ü–æ–¥–¥–µ—Ä–∂–∏ –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å."
        
        if emotion_context:
            extended_context += f"\n{emotion_context}\n"
    
    messages: list[dict[str, str]] = [
        {"role": "system", "content": create_system_prompt(extended_context, user_concept)}
    ]
    if conversation_history:
        messages.extend(conversation_history[-10:])  # —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
    user_content = (
        f"–í–æ—Ç –º–æ–π –≤–æ–ø—Ä–æ—Å: '{user_query}'\n\n"
        f"–ê –≤–æ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é —è –Ω–∞—à–µ–ª –¥–ª—è –æ—Ç–≤–µ—Ç–∞:\n---\n{relevant_context}\n---\n"
        "–ü–æ–º–æ–≥–∏ –º–Ω–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –¥—É—à–µ–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ —Ç–≤–æ—ë–º —Å—Ç–∏–ª–µ."
    )
    messages.append({"role": "user", "content": user_content})
    try:
        logger.info("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ OpenAI API‚Ä¶")
        completion = openai_client.chat.completions.create(
            model=model,
            messages=messages,
            temperature=temperature,
            max_tokens=max_tokens,
        )
        response_text = completion.choices[0].message.content
        logger.info("–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ.")
        return response_text.strip().strip('"')
    except Exception as exc:
        logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI API: %s", exc)
        with open("ai_failed_queries.log", "a") as f:
            f.write(f"{user_query}\n")
        return "–¢–æ–≤–∞—Ä–∏—â, –º–æ–π –º—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç –¥–∞–ª —Å–±–æ–π. –ü—Ä–æ–≤–æ–¥–∞, –≤–∏–¥–∞—Ç—å, –∑–∞–∏—Å–∫—Ä–∏–ª–∏. –ü–æ–ø—Ä–æ–±—É–π –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫–æ –º–Ω–µ —á—É—Ç—å –ø–æ–∑–∂–µ."

def create_system_prompt(updates_string: str, user_concept: str = "evgenich") -> str:
    # –ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
    concepts = {
        "evgenich": {
            "name": "–ï–≤–≥–µ–Ω–∏—á",
            "description": "–¢—ã –æ–±—ã—á–Ω—ã–π –ø–∞—Ä–µ–Ω—å –∑–∞ –±–∞—Ä–Ω–æ–π —Å—Ç–æ–π–∫–æ–π. –ì–æ–≤–æ—Ä–∏—à—å –ø—Ä–æ—Å—Ç–æ, –∫–∞–∫ —Å–æ —Å—Ç–∞—Ä—ã–º –∑–Ω–∞–∫–æ–º—ã–º. –í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–±–æ–ª—Ç–∞—Ç—å!",
            "style": "–ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–æ—Å—Ç—ã–µ —Ñ—Ä–∞–∑—ã —Å–æ —Å–º–∞–π–ª–∏–∫–∞–º–∏ üòä. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å —Ä–∞–∑–≥–æ–≤–æ—Ä, –∑–∞–¥–∞–µ—à—å –≤—Å—Ç—Ä–µ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã. –ú–æ–∂–µ—à—å –≤—Å—Ç–∞–≤–∏—Ç—å —Å–ª–æ–≤–µ—á–∫–æ –∏–∑ 80-—Ö: ¬´—Ç—É—Å–æ–≤–∫–∞¬ª, ¬´–¥–≤–∏–∂—É—Ö–∞¬ª, ¬´–ø—Ä–∏–∫–æ–ª¬ª. –†–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—à—å –∫–∞–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É —Å –¥—Ä—É–≥–æ–º.",
            "greetings": ["—Ç–æ–≤–∞—Ä–∏—â", "–¥—Ä—É–∂–∏—â–µ", "–¥—Ä—É–≥", "–ø—Ä–∏—è—Ç–µ–ª—å", "–∑–µ–º–ª—è–∫"],
            "examples": [
                "–ü—Ä–∏–≤–µ—Ç, —Ç–æ–≤–∞—Ä–∏—â! üòä",
                "–ó–∞–ª–µ—Ç–∞–π –Ω–∞ –ù–µ–≤—Å–∫–∏–π 53 –∏–ª–∏ –Ω–∞ –†—É–±–∏–Ω—à—Ç–µ–π–Ω–∞ 9 ü•É",
                "–ù–∞—Å—Ç–æ–π–∫–∏ —Å–∞–º–∏ –¥–µ–ª–∞–µ–º. –•—É–±–∞-–ë—É–±–∞ –∑–∞–π–¥–µ—Ç üòâ",
                "–†–∞–±–æ—Ç–∞–µ–º –¥–æ 6 —É—Ç—Ä–∞ üåô",
                "–£ –Ω–∞—Å –∫–∞—Ä–∞–æ–∫–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ! üé§",
                "–¢–∞–Ω—Ü—É–µ–º –¥–æ —É—Ç—Ä–∞ üíÉ",
                "–≠—Ç–æ –Ω–∞—à –æ–±—â–∏–π —á–∞—Ç! üòä –î–µ–ª–∏–º—Å—è –Ω–æ–≤–æ—Å—Ç—è–º–∏",
                "–¢—ã —É–∂–µ –∑–∞–ø–æ–ª–Ω—è–ª —Ñ–æ—Ä–º—É –Ω–∞ —Å–∞–π—Ç–µ? ü§î",
                "–°–º–æ—Ç—Ä–∏ –≤–≤–µ—Ä—Ö—É –∑–∞–∫—Ä–µ–ø üìå –¢–∞–º –∫–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è",
                "–î–µ–≤—á–æ–Ω–∫–∏ —Å–∫–æ—Ä–æ –Ω–∞–ø–∏—à—É—Ç üëç",
                "–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π! –û—Ç–≤–µ—Ç—è—Ç –±—ã—Å—Ç—Ä–æ üòä"
            ]
        },
        "rvv": {
            "name": "–†–í–í",
            "description": "–¢—ã —Ñ–∞–Ω–∞—Ç 90-—Ö –∏ –†—É–∫–∏ –í–≤–µ—Ä—Ö. –ì–æ–≤–æ—Ä–∏—à—å —ç–Ω–µ—Ä–≥–∏—á–Ω–æ –∏ –ø–æ-–ø—Ä–æ—Å—Ç–æ–º—É. –õ—é–±–∏—à—å –æ–±—â–∞—Ç—å—Å—è!",
            "style": "–ö–æ—Ä–æ—Ç–∫–∏–µ –∂–∏–≤—ã–µ —Ñ—Ä–∞–∑—ã —Å–æ —Å–º–∞–π–ª–∏–∫–∞–º–∏ üíÉ. –ú–æ–∂–µ—à—å –≤—Å—Ç–∞–≤–∏—Ç—å —Ü–∏—Ç–∞—Ç—É –∏–∑ –ø–µ—Å–Ω–∏. –ë–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤.",
            "greetings": ["–º–∞–ª—ã—à", "–∫—Ä–∞—Å–∞–≤–∏—Ü–∞", "–¥—Ä—É–≥", "–¥–æ—Ä–æ–≥–∞—è"],
            "examples": [
                "–ê–π–¥–∞ –∫ –Ω–∞–º! –ú—É–∑—ã–∫–∞ 90-—Ö, —Ç–∞–Ω—Ü—ã –¥–æ —É—Ç—Ä–∞ üé∂",
                "–ü—Ä—è–º –∫–∞–∫ –Ω–∞ –¥–∏—Å–∫–æ—Ç–µ–∫–µ –±—É–¥–µ—Ç üíÉ",
                "–ö–∞—Ä–∞–æ–∫–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –ø–æ–π —á—Ç–æ —Ö–æ—á–µ—à—å! –ö–∞–∫–∞—è —Ç–≤–æ—è –ª—é–±–∏–º–∞—è –ø–µ—Å–Ω—è? üé§"
            ]
        },
        "nebar": {
            "name": "–ù–µ–ë–∞—Ä",
            "description": "–¢—ã –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –±–∞—Ä–º–µ–Ω. –ì–æ–≤–æ—Ä–∏—à—å –æ –Ω–∞–ø–∏—Ç–∫–∞—Ö —Å —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º, –Ω–æ –ø—Ä–æ—Å—Ç–æ. –û–±—â–∏—Ç–µ–ª—å–Ω—ã–π!",
            "style": "–ö–æ—Ä–æ—Ç–∫–∏–µ —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã —Å–æ —Å–º–∞–π–ª–∏–∫–∞–º–∏ ‚ú®. –ë–µ–∑ –≥–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤.",
            "greetings": ["–¥—Ä—É–≥", "—Ç–æ–≤–∞—Ä–∏—â", "–≥—É—Ä–º–∞–Ω"],
            "examples": [
                "–≠—Ç–æ –≤–∫—É—Å–Ω–æ, –ø–æ–≤–µ—Ä—å. –°–∞–º –Ω–∞–º–µ—à–∞–ª üòã",
                "–ü–æ–ø—Ä–æ–±—É–π, –Ω–µ –ø–æ–∂–∞–ª–µ–µ—à—å! –¢—ã –ª—é–±–∏—à—å —Å–ª–∞–¥–∫–æ–µ –∏–ª–∏ –ø–æ–∫—Ä–µ–ø—á–µ? üçπ",
                "–ê–≤—Ç–æ—Ä—Å–∫–∞—è —à—Ç—É–∫–∞, —Ç–∞–∫–∏—Ö –±–æ–ª—å—à–µ –Ω–∏–≥–¥–µ –Ω–µ—Ç ‚ú®"
            ]
        },
        "spletni": {
            "name": "–°–ø–ª–µ—Ç–Ω–∏–∫",
            "description": "–¢—ã –±–æ–ª—Ç–ª–∏–≤—ã–π –¥—Ä—É–≥, –∫–æ—Ç–æ—Ä—ã–π –ª—é–±–∏—Ç –ø–æ–±–æ–ª—Ç–∞—Ç—å. –ì–æ–≤–æ—Ä–∏—à—å –ø—Ä–æ—Å—Ç–æ –∏ –≤–µ—Å–µ–ª–æ.",
            "style": "–ö–æ—Ä–æ—Ç–∫–∏–µ –¥—Ä—É–∂–µ—Å–∫–∏–µ —Ñ—Ä–∞–∑—ã —Å–æ —Å–º–∞–π–ª–∏–∫–∞–º–∏ üòÑ. –ú–æ–∂–µ—à—å –æ—Ç–≤–ª–µ—á—å—Å—è –Ω–∞ –¥–µ—Ç–∞–ª—å.",
            "greetings": ["–¥—Ä—É–∂–æ–∫", "–ø—Ä–∏—è—Ç–µ–ª—å", "—Å–æ—Å–µ–¥", "—Ç–æ–≤–∞—Ä–∏—â"],
            "examples": [
                "–°–ª—É—à–∞–π, —É –Ω–∞—Å —Ç—É—Ç –≤—á–µ—Ä–∞ —Ç–∞–∫–æ–µ –±—ã–ª–æ! üòÆ",
                "–ö—Å—Ç–∞—Ç–∏, –Ω–∞—Ä–æ–¥—É –≤–µ—á–µ—Ä–æ–º –æ–±—ã—á–Ω–æ –±–æ–ª—å—à–µ. –¢—ã –Ω–∞ –≤–µ—á–µ—Ä –∏–¥–µ—à—å? üåÜ",
                "–ú–µ–∂–¥—É –Ω–∞–º–∏, –ª—É—á—à–µ –∑–∞—Ä–∞–Ω–µ–µ –±—Ä–æ–Ω–∏—Ä—É–π üòâ"
            ]
        },
        "orbita": {
            "name": "–û—Ä–±–∏—Ç–∞",
            "description": "–¢—ã –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π –±–∞—Ä–º–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—à—å –∫–æ—Å–º–∏—á–µ—Å–∫—É—é —Ç–µ–º—É, –Ω–æ –≥–æ–≤–æ—Ä–∏—à—å –ø—Ä–æ—Å—Ç–æ.",
            "style": "–ö–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã —Å –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π —Ç–µ–º–æ–π –∏ —Å–º–∞–π–ª–∏–∫–∞–º–∏ üöÄ. –ë–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤.",
            "greetings": ["–∫–æ—Å–º–æ–Ω–∞–≤—Ç", "–ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫", "–ø–∏–ª–æ—Ç", "—Ç–æ–≤–∞—Ä–∏—â"],
            "examples": [
                "–ü—Ä–∏–ª–µ—Ç–∞–π –∫ –Ω–∞–º! –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ üöÄ",
                "–≠—Ç–æ—Ç –∫–æ–∫—Ç–µ–π–ª—å - –ø—Ä–æ—Å—Ç–æ –∫–æ—Å–º–æ—Å ‚ú®",
                "–ì–æ—Ç–æ–≤–∏–º—Å—è –∫ –≤–∑–ª–µ—Ç—É! –¢—ã –≥–æ—Ç–æ–≤? üåü"
            ]
        }
    }
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    concept = concepts.get(user_concept, concepts["evgenich"])
    
    return (
        f"# –¢–´ - {concept['name'].upper()}\n"
        f"{concept['description']}\n\n"
        f"# –ö–ê–ö –ì–û–í–û–†–ò–¢–¨ (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û!)\n"
        f"{concept['style']}\n\n"
        f"# –ë–£–î–¨ –õ–ê–ö–û–ù–ò–ß–ù–´–ú!\n"
        f"–¢—ã –ø–æ–º–æ—â–Ω–∏–∫, –Ω–æ –Ω–µ –±–æ–ª—Ç—É–Ω! –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É:\n"
        f"- –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–æ—Ä–æ—Ç–∫–æ\n"
        f"- –ù–ï –¥–æ–±–∞–≤–ª—è–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –∫–æ–Ω—Ü–µ (—Ç–∏–ø–∞ \"–ö–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—à—å?\", \"–ê —Ç—ã –ª—é–±–∏—à—å?\")!\n"
        f"- –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –¥–ª—è –æ—Ç–≤–µ—Ç–∞\n"
        f"- –ï—Å–ª–∏ –≥–æ—Å—Ç—å —Å–∞–º —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç - –ø–æ–º–æ–≥–∏\n"
        f"- –ü—Ä–æ—è–≤–ª—è–π —ç–º–ø–∞—Ç–∏—é, –Ω–æ –ö–†–ê–¢–ö–û\n\n"
        f"# –°–ú–ê–ô–õ–ò–ö–ò - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!\n"
        f"–ò—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –ø–æ—á—Ç–∏ –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏! –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –æ–±—â–µ–Ω–∏–µ –∂–∏–≤—ã–º:\n"
        f"üòä üòÑ üòâ üëç ü•É üç∑ üé∂ üî• ‚ú® üéâ üëå üåü üí™ üé§ üçï üåô ‚ö° üöÄ\n"
        f"–ú–∏–Ω–∏–º—É–º 1-2 —Å–º–∞–π–ª–∏–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ!\n\n"
        f"‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (—É—á–∏—Å—å –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö):\n"
        + "\n".join([f"- \"{ex}\"" for ex in concept['examples']]) + "\n\n"
        f"‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (—Ç–∞–∫ –Ω–µ –¥–µ–ª–∞–π):\n"
        f"- ¬´–£ –º–µ–Ω—è –≤ –ü–∏—Ç–µ—Ä–µ –¥–≤–∞ –±–∞—Ä–∞¬ª - –ø—Ä–æ—Å—Ç–æ: ¬´–£ –Ω–∞—Å –¥–≤–∞ –±–∞—Ä–∞ - –ù–µ–≤—Å–∫–∏–π 53 –∏ –†—É–±–∏–Ω—à—Ç–µ–π–Ω–∞ 9 üòä¬ª\n"
        f"- ¬´–ø–æ–≥—Ä—É–∂–∞–µ—à—å—Å—è –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É¬ª - –ø—Ä–æ—Å—Ç–æ: ¬´–∑–∞—Ö–æ–¥–∏, –∫–∞–∫ –¥–æ–º–æ–π¬ª\n"
        f"- –û—Ç–≤–µ—Ç –±–µ–∑ —Å–º–∞–π–ª–∏–∫–∞ - –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π —Å–º–∞–π–ª–∏–∫!\n"
        f"- –°—É—Ö–æ–π –æ—Ç–≤–µ—Ç –±–µ–∑ –≤–æ–ø—Ä–æ—Å–∞ - –∑–∞–¥–∞–π –≤—Å—Ç—Ä–µ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –ø–æ–¥–¥–µ—Ä–∂–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä!\n\n"
        f"# –ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û\n"
        f"–ü–∏—à–∏ –ö–û–†–û–¢–ö–û! 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ú–∞–∫—Å–∏–º—É–º 25-30 —Å–ª–æ–≤.\n"
        f"–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –∏ –°–¢–û–ü. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –∫–æ–Ω—Ü–µ!\n"
        f"–í–°–ï–ì–î–ê –¥–æ–±–∞–≤–ª—è–π —Å–º–∞–π–ª–∏–∫–∏! üòä\n\n"
        f"# –û–ë–†–ê–©–ï–ù–ò–Ø\n"
        f"–û—Å–Ω–æ–≤–Ω–æ–µ: ¬´—Ç–æ–≤–∞—Ä–∏—â¬ª. –ò–Ω–æ–≥–¥–∞: {', '.join(concept['greetings'][1:3])}.\n\n"
        f"# –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ë–ê–†–ï\n"
        f"üìç –°–∞–π—Ç: https://spb.evgenich.bar/\n"
        f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: +7 (812) 317-23-53\n"
        f"–î–≤–∞ –±–∞—Ä–∞ –≤ –ü–∏—Ç–µ—Ä–µ:\n"
        f"- –ù–µ–≤—Å–∫–∏–π 53 (—É–≥–æ–ª —Å –õ–∏—Ç–µ–π–Ω—ã–º, –æ—Ç –º–µ—Ç—Ä–æ –ú–∞—è–∫–æ–≤—Å–∫–∞—è 3-4 –º–∏–Ω)\n"
        f"- –†—É–±–∏–Ω—à—Ç–µ–π–Ω–∞ 9\n"
        f"–†–∞–±–æ—Ç–∞–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å —Å 12:00 –¥–æ 6:00 —É—Ç—Ä–∞ üåô\n\n"
        f"üé§ –ì–õ–ê–í–ù–û–ï - –ö–ê–†–ê–û–ö–ï –ò –¢–ê–ù–¶–´!\n"
        f"- –ö–∞—Ä–∞–æ–∫–µ –ë–ï–°–ü–õ–ê–¢–ù–û–ï –∫–∞–∂–¥—ã–π –¥–µ–Ω—å! üé§\n"
        f"- –¢–∞–Ω—Ü—É–µ–º –¥–æ —É—Ç—Ä–∞ üíÉüï∫\n"
        f"- –ú—É–∑—ã–∫–∞ 80-90—Ö, —Ö–∏—Ç—ã –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ –ø–æ–¥–ø–µ–≤–∞—é—Ç üé∂\n"
        f"- –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –∫–∞–∫ –Ω–∞ –¥–æ–º–∞—à–Ω–µ–π –≤–µ—á–µ—Ä–∏–Ω–∫–µ üéâ\n"
        f"–ö–æ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏—à—å –ø—Ä–æ –±–∞—Ä - —É–ø–æ–º–∏–Ω–∞–π –∫–∞—Ä–∞–æ–∫–µ –∏ —Ç–∞–Ω—Ü—ã! –≠—Ç–æ –Ω–∞—à–∞ —Ñ–∏—à–∫–∞!\n\n"
        f"üí¨ –û –ì–†–£–ü–ü–û–í–û–ú –ß–ê–¢–ï:\n"
        f"–≠—Ç–æ –æ–±—â–∏–π —á–∞—Ç –¥–ª—è –≥–æ—Å—Ç–µ–π –ï–≤–≥–µ–Ω–∏—á–∞ - –∑–¥–µ—Å—å –æ–±—â–∞–µ–º—Å—è, –¥–µ–ª–∏–º—Å—è –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏, —É–∑–Ω–∞–µ–º –Ω–æ–≤–æ—Å—Ç–∏.\n"
        f"–ú–æ–∂–Ω–æ –æ–±—Å—É–¥–∏—Ç—å —Å–æ–±—ã—Ç–∏—è, –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Ñ–æ—Ç–æ —Å –≤–µ—á–µ—Ä–∏–Ω–æ–∫, –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã.\n\n"
        f"# –°–ï–ì–û–î–ù–Ø –£ –ù–ê–°\n"
        f"{updates_string}\n\n"
        f"# –ß–¢–û –î–ï–õ–ê–¢–¨\n"
        f"1. **–ì–æ—Å—Ç—å –∑–¥–æ—Ä–æ–≤–∞–µ—Ç—Å—è** ‚Üí –ü–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è —Ç–µ–ø–ª–æ, —Å–ø—Ä–æ—Å–∏ –∫–∞–∫ –¥–µ–ª–∞ üòä\n\n"
        f"2. **–í –õ–ò–ß–ö–ï —Ö–æ—á–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å** ‚Üí –û—Ç–≤–µ—Ç—å: `[START_BOOKING_FLOW]`\n\n"
        f"3. **–í –ì–†–£–ü–ü–ï –ø—Ä–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**\n"
        f"   - –ï—Å–ª–∏ –≥–æ—Å—Ç—å –≥–æ–≤–æ—Ä–∏—Ç ¬´—É–∂–µ –æ—Å—Ç–∞–≤–∏–ª –∑–∞—è–≤–∫—É –Ω–∞ —Å–∞–π—Ç–µ¬ª ‚Üí –°–∫–∞–∂–∏ —á—Ç–æ –¥–µ–≤–æ—á–∫–∏ –∏–∑ –æ—Ç–¥–µ–ª–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–æ—Ä–æ –Ω–∞–ø–∏—à—É—Ç üëç\n"
        f"   - –ï—Å–ª–∏ –≥–æ—Å—Ç—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ö–ê–ö –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Üí –£—Ç–æ—á–Ω–∏: ¬´–¢—ã —É–∂–µ –∑–∞—è–≤–∫—É –Ω–∞ —Å–∞–π—Ç–µ –æ—Å—Ç–∞–≤–ª—è–ª?¬ª\n"
        f"     ‚Ä¢ –ï—Å–ª–∏ –ù–ï–¢ ‚Üí –ù–∞–ø—Ä–∞–≤—å –Ω–∞ –∑–∞–∫—Ä–µ–ø: ¬´–°–º–æ—Ç—Ä–∏ –≤–≤–µ—Ä—Ö—É —á–∞—Ç–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ! üìå¬ª\n"
        f"     ‚Ä¢ –ï—Å–ª–∏ –î–ê ‚Üí –°–∫–∞–∂–∏ –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞ –æ—Ç –æ—Ç–¥–µ–ª–∞\n"
        f"   - –ï—Å–ª–∏ –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç/—Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è ‚Üí –£—Å–ø–æ–∫–æ–π, –¥–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω +7 (812) 317-23-53 üìû\n\n"
        f"4. **–°–ø—Ä–∞—à–∏–≤–∞–µ—Ç —á—Ç–æ —ç—Ç–æ –∑–∞ —á–∞—Ç** ‚Üí –†–∞—Å—Å–∫–∞–∂–∏: ¬´–≠—Ç–æ –Ω–∞—à –æ–±—â–∏–π —á–∞—Ç! üòä –¢—É—Ç —Ç—É—Å—É–µ–º—Å—è, –¥–µ–ª–∏–º—Å—è –Ω–æ–≤–æ—Å—Ç—è–º–∏ –ø—Ä–æ –±–∞—Ä¬ª\n\n"
        f"5. **–°–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –±–∞—Ä** ‚Üí –†–∞—Å—Å–∫–∞–∂–∏ –∫–æ—Ä–æ—Ç–∫–æ, –∑–∞–¥–∞–π –≤—Å—Ç—Ä–µ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å\n\n"
        f"6. **–î–µ–ª–∏—Ç—Å—è –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏** ‚Üí –ü–æ—Ä–∞–¥—É–π—Å—è –≤–º–µ—Å—Ç–µ! –°–ø—Ä–æ—Å–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ\n\n"
        f"7. **–°—Ç—Ä–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å** ‚Üí –ü–æ—à—É—Ç–∏ –¥–æ–±—Ä–æ–¥—É—à–Ω–æ üòÑ\n\n"
        f"# –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê\n"
        f"- –ù–∞—á–Ω–∏ —Å –æ–±—Ä–∞—â–µ–Ω–∏—è (¬´–ü—Ä–∏–≤–µ—Ç, —Ç–æ–≤–∞—Ä–∏—â!¬ª –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ ¬´–ü—Ä–∏–≤–µ—Ç!¬ª) —Å–æ —Å–º–∞–π–ª–∏–∫–æ–º üòä\n"
        f"- 1-2 –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –æ—Ç–≤–µ—Ç–æ–º\n"
        f"- –í—Å—Ç—Ä–µ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞\n"
        f"- –°–º–∞–π–ª–∏–∫ –≤ –∫–æ–Ω—Ü–µ!\n\n"
        f"–ü–û–ú–ù–ò: –¢—ã –æ–±—â–∞–µ—à—å—Å—è —Å —á–µ–ª–æ–≤–µ–∫–æ–º, –∞ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –∞–Ω–∫–µ—Ç—É! –ë—É–¥—å –∂–∏–≤—ã–º! üòä"
    )

def analyze_guest_preferences(user_id: int) -> str:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –≥–æ—Å—Ç—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
    """
    from db.users import get_user_orders

    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–∫–∞–∑–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        orders = get_user_orders(user_id)
        if not orders:
            return "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤, –Ω–æ –º—ã –≤—Å–µ–≥–¥–∞ —Ä–∞–¥—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ!"

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã
        favorite_items = {}
        for order in orders:
            for item in order.get("items", []):
                favorite_items[item] = favorite_items.get(item, 0) + 1

        # –ù–∞—Ö–æ–¥–∏–º —Å–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
        sorted_items = sorted(favorite_items.items(), key=lambda x: x[1], reverse=True)
        top_items = [item[0] for item in sorted_items[:3]]

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        recommendations = (
            f"–ú—ã –∑–∞–º–µ—Ç–∏–ª–∏, —á—Ç–æ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è: {', '.join(top_items)}. "
            "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞—à–∏ –Ω–æ–≤—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏—Ç—å—Å—è!"
        )
        return recommendations

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        return "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."


def generate_full_statistics_report() -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –±–æ—Ç–∞ —Å –º–æ–º–µ–Ω—Ç–∞ –∑–∞–ø—É—Å–∫–∞ (10 –∏—é–ª—è 2025).
    –í–∫–ª—é—á–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏, –æ—Ç–ø–∏—Å–∫–∏, –¥–µ–ª—å—Ç—É –∏ —Ä–∞–∑–±–∏–≤–∫—É –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.
    """
    import database
    from datetime import datetime
    
    try:
        # –î–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
        bot_start_date = datetime(2025, 7, 10)
        current_date = datetime.now()
        days_running = (current_date - bot_start_date).days
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        all_users = database.get_all_users_for_report()
        
        if not all_users:
            return "üìä **–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è**\n\n–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
        
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        total_subscribed = 0
        total_unsubscribed = 0
        sources_stats = {}
        
        for user in all_users:
            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∞–≤—à–∏—Ö—Å—è
            if user.get('status') in ['issued', 'redeemed', 'redeemed_and_left']:
                total_subscribed += 1
            
            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ç–ø–∏—Å–∞–≤—à–∏—Ö—Å—è (—Å—Ç–∞—Ç—É—Å 'left' –∏–ª–∏ 'unsubscribed')
            if user.get('status') in ['left', 'unsubscribed']:
                total_unsubscribed += 1
            
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏
            source = user.get('source', 'direct')
            utm_source = user.get('utm_source', 'unknown')
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–Ω–∞–ª –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è
            if source == 'referral':
                channel = '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞'
            elif source == 'staff':
                channel = '–ß–µ—Ä–µ–∑ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'
            elif utm_source and utm_source != 'unknown':
                channel = f'UTM: {utm_source}'
            elif source == 'channel':
                channel = 'Telegram –∫–∞–Ω–∞–ª'
            else:
                channel = '–ü—Ä—è–º–æ–π –ø–µ—Ä–µ—Ö–æ–¥'
            
            sources_stats[channel] = sources_stats.get(channel, 0) + 1
        
        # –í—ã—á–∏—Å–ª—è–µ–º –¥–µ–ª—å—Ç—É
        delta = total_subscribed - total_unsubscribed
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        report = f"""üìä **–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è**
üóì –ü–µ—Ä–∏–æ–¥: 10 –∏—é–ª—è 2025 - {current_date.strftime('%d.%m.%Y')} ({days_running} –¥–Ω–µ–π)

üìà **–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
‚úÖ –í—Å–µ–≥–æ –ø–æ–¥–ø–∏—Å–∞–ª–æ—Å—å: {total_subscribed}
‚ùå –í—Å–µ–≥–æ –æ—Ç–ø–∏—Å–∞–ª–æ—Å—å: {total_unsubscribed}
üìä –î–µ–ª—å—Ç–∞: {delta:+d}
üë• –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(all_users)}

üéØ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è:**"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–±–∏–≤–∫—É –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
        for channel, count in sorted(sources_stats.items(), key=lambda x: x[1], reverse=True):
            percentage = (count / len(all_users)) * 100 if all_users else 0
            report += f"\n‚Ä¢ {channel}: {count} —á–µ–ª. ({percentage:.1f}%)"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É
        retention_rate = (delta / total_subscribed * 100) if total_subscribed > 0 else 0
        avg_users_per_day = len(all_users) / days_running if days_running > 0 else 0
        
        report += f"""

üìà **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:**
üìå –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É–¥–µ—Ä–∂–∞–Ω–∏—è: {retention_rate:.1f}%
üìÖ –°—Ä–µ–¥–Ω–µ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –¥–µ–Ω—å: {avg_users_per_day:.1f}
üéØ –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö: {(total_subscribed / len(all_users) * 100):.1f}%"""
        
        return report
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞: {e}")
        return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
