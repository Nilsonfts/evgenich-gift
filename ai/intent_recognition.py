# /ai/intent_recognition.py
"""
–£–º–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"""
import re
import logging

logger = logging.getLogger("intent_recognition")

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –Ω–∞–º–µ—Ä–µ–Ω–∏–π
INTENT_PATTERNS = {
    "drinks": {
        "keywords": ["–Ω–∞–ø–∏—Ç–∫–∏", "–∫–æ–∫—Ç–µ–π–ª–∏", "—á—Ç–æ –ø–∏—Ç—å", "–≤—ã–ø–∏—Ç—å", "–∞–ª–∫–æ–≥–æ–ª—å", "–ø–∏–≤–æ", "–≤–∏–Ω–æ"],
        "patterns": [r"—á—Ç–æ.*\b(–ø–∏—Ç—å|–≤—ã–ø–∏—Ç—å)\b", r"–∫–∞–∫–∏–µ.*\b(–Ω–∞–ø–∏—Ç–∫–∏|–∫–æ–∫—Ç–µ–π–ª–∏)\b"]
    },
    "location": {
        "keywords": ["–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è", "–∞–¥—Ä–µ—Å", "–∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è", "–≥–¥–µ –≤—ã", "–∫–∞–∫ –Ω–∞–π—Ç–∏", "–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ", "–≥–¥–µ —ç—Ç–æ"],
        "patterns": [r"–≥–¥–µ.*\b(–Ω–∞—Ö–æ–¥–∏—Ç—Å—è|–≤—ã|–±–∞—Ä|–µ–≤–≥–µ–Ω–∏—á)\b", r"–∫–∞–∫.*–¥–æ–±—Ä–∞—Ç—å—Å—è", r"–∫–∞–∫–æ–π.*–∞–¥—Ä–µ—Å"]
    },
    "hours": {
        "keywords": ["–∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç", "—á–∞—Å—ã —Ä–∞–±–æ—Ç—ã", "—Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã", "—Ä–∞–±–æ—Ç–∞–µ—Ç–µ", "–æ—Ç–∫—Ä—ã—Ç–æ", "–∑–∞–∫—Ä—ã—Ç–æ", "–¥–æ —Å–∫–æ–ª—å–∫–∏"],
        "patterns": [r"–∫–æ–≥–¥–∞.*\b(–æ—Ç–∫—Ä—ã—Ç|—Ä–∞–±–æ—Ç–∞|–æ—Ç–∫—Ä—ã—Ç–æ)\b", r"–¥–æ.*—Å–∫–æ–ª—å–∫–∏", r"—Ä–µ–∂–∏–º.*—Ä–∞–±–æ—Ç—ã", r"\b—á–∞—Å—ã\b"]
    },
    "booking": {
        "keywords": ["–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å", "–±—Ä–æ–Ω—å", "—Å—Ç–æ–ª–∏–∫", "—Ä–µ–∑–µ—Ä–≤", "–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å"],
        "patterns": [r"–∑–∞–±—Ä–æ–Ω–∏—Ä", r"\b–±—Ä–æ–Ω—å\b", r"—Å—Ç–æ–ª–∏–∫.*\b(–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å|–Ω—É–∂–µ–Ω)\b"]
    },
    "promo": {
        "keywords": ["–∞–∫—Ü–∏–∏", "—Å–∫–∏–¥–∫–∏", "–ø—Ä–æ–º–æ", "—Å–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ", "–∞–∫—Ü–∏—è", "–≤—ã–≥–æ–¥–∞", "–±–æ–Ω—É—Å"],
        "patterns": [r"–∫–∞–∫–∏–µ.*\b(–∞–∫—Ü–∏–∏|—Å–∫–∏–¥–∫–∏|–ø—Ä–æ–º–æ)\b", r"–µ—Å—Ç—å.*\b(–∞–∫—Ü–∏|—Å–∫–∏–¥–∫)\b"]
    },
    "events": {
        "keywords": ["–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è", "—Å–æ–±—ã—Ç–∏—è", "–∫–æ–Ω—Ü–µ—Ä—Ç", "–≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ", "—á—Ç–æ —Å–µ–≥–æ–¥–Ω—è", "–∞—Ñ–∏—à–∞"],
        "patterns": [r"–∫–∞–∫–∏–µ.*\b(–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è|—Å–æ–±—ã—Ç–∏—è)\b", r"—á—Ç–æ.*\b(—Å–µ–≥–æ–¥–Ω—è|–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç|–±—É–¥–µ—Ç)\b"]
    },
    "complaint": {
        "keywords": ["–∂–∞–ª–æ–±–∞", "–ø–ª–æ—Ö–æ", "—É–∂–∞—Å–Ω–æ", "–Ω–µ–¥–æ–≤–æ–ª–µ–Ω", "—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω", "–≤–æ–∑–º—É—Ç–∏—Ç–µ–ª—å–Ω–æ", "–æ—Ç–≤—Ä–∞—Ç–∏—Ç–µ–ª—å–Ω–æ"],
        "patterns": [r"\b(–∂–∞–ª–æ–±–∞|–ø–ª–æ—Ö–æ|—É–∂–∞—Å–Ω–æ)\b", r"–æ—á–µ–Ω—å.*\b(–ø–ª–æ—Ö|—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞)\b"]
    },
    "compliment": {
        "keywords": ["–æ—Ç–ª–∏—á–Ω–æ", "—Å—É–ø–µ—Ä", "–∫–ª–∞—Å—Å–Ω–æ", "–∫—Ä—É—Ç–æ", "–≤–æ—Å—Ö–∏—Ç–∏—Ç–µ–ª—å–Ω–æ", "–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ", "–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ", "—Å–ø–∞—Å–∏–±–æ"],
        "patterns": [r"\b(–æ—Ç–ª–∏—á–Ω–æ|—Å—É–ø–µ—Ä|–∫–ª–∞—Å—Å|–∫—Ä—É—Ç–æ)\b", r"–æ—á–µ–Ω—å.*\b(–≤–∫—É—Å–Ω–æ|—Ö–æ—Ä–æ—à–æ|–ø–æ–Ω—Ä–∞–≤–∏–ª)\b"]
    },
    "contact": {
        "keywords": ["—Ç–µ–ª–µ—Ñ–æ–Ω", "–Ω–æ–º–µ—Ä", "–ø–æ–∑–≤–æ–Ω–∏—Ç—å", "—Å–≤—è–∑–∞—Ç—å—Å—è", "–∫–æ–Ω—Ç–∞–∫—Ç"],
        "patterns": [r"–∫–∞–∫–æ–π.*\b(—Ç–µ–ª–µ—Ñ–æ–Ω|–Ω–æ–º–µ—Ä)\b", r"–∫–∞–∫.*\b(—Å–≤—è–∑–∞—Ç—å—Å—è|–ø–æ–∑–≤–æ–Ω–∏—Ç—å)\b"]
    }
}

def detect_intent(user_text: str) -> dict:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–µ–∫—Å—Ç–∞
    
    Returns:
        dict: {"intent": "–Ω–∞–∑–≤–∞–Ω–∏–µ", "confidence": 0.0-1.0, "matches": [...]}
    """
    text_lower = user_text.lower()
    
    detected_intents = []
    
    for intent_name, patterns in INTENT_PATTERNS.items():
        confidence = 0.0
        matches = []
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        for keyword in patterns["keywords"]:
            if keyword in text_lower:
                confidence += 0.3
                matches.append(keyword)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
        for pattern in patterns.get("patterns", []):
            if re.search(pattern, text_lower, re.IGNORECASE):
                confidence += 0.5
                matches.append(f"pattern:{pattern}")
        
        if confidence > 0:
            detected_intents.append({
                "intent": intent_name,
                "confidence": min(confidence, 1.0),
                "matches": matches
            })
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
    detected_intents.sort(key=lambda x: x["confidence"], reverse=True)
    
    if detected_intents:
        logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–∞–º–µ—Ä–µ–Ω–∏—è: {detected_intents}")
        return detected_intents[0]
    
    return {"intent": "general", "confidence": 0.0, "matches": []}


def detect_emotion(user_text: str) -> dict:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è
    
    Returns:
        dict: {"emotion": "–Ω–∞–∑–≤–∞–Ω–∏–µ", "intensity": 0.0-1.0}
    """
    text_lower = user_text.lower()
    
    emotions = {
        "joy": ["—Ä–∞–¥", "—Å—á–∞—Å—Ç–ª–∏–≤", "–≤–æ—Å—Ç–æ—Ä–≥", "–æ—Ç–ª–∏—á–Ω–æ", "—Å—É–ø–µ—Ä", "–∫–ª–∞—Å—Å", "–∫—Ä—É—Ç–æ", "üéâ", "üòä", "üòÑ", "‚ù§Ô∏è"],
        "sadness": ["–≥—Ä—É—Å—Ç–Ω", "–ø–µ—á–∞–ª—å", "—Ä–∞—Å—Å—Ç—Ä–æ", "–∂–∞–ª—å", "üò¢", "üòû"],
        "anger": ["–∑–ª–æ–π", "–±–µ—Å–∏—Ç", "—Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç", "–≤–æ–∑–º—É—Ç–∏—Ç–µ–ª—å–Ω–æ", "—É–∂–∞—Å–Ω–æ", "üò†", "üò°"],
        "surprise": ["—É–¥–∏–≤–ª–µ–Ω", "–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ", "–≤–æ—Ç —ç—Ç–æ –¥–∞", "–Ω–∏—á–µ–≥–æ —Å–µ–±–µ", "üòÆ", "üò≤"],
        "neutral": []
    }
    
    detected_emotion = "neutral"
    max_intensity = 0.0
    
    for emotion, keywords in emotions.items():
        intensity = 0.0
        for keyword in keywords:
            if keyword in text_lower:
                intensity += 0.3
        
        if intensity > max_intensity:
            max_intensity = intensity
            detected_emotion = emotion
    
    # –£—Å–∏–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –∏ —ç–º–æ–¥–∑–∏
    if "!" in user_text:
        max_intensity = min(max_intensity + 0.2, 1.0)
    
    return {
        "emotion": detected_emotion,
        "intensity": min(max_intensity, 1.0)
    }


def analyze_user_type(user_info: dict, visits_count: int) -> str:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        str: "new", "regular", "vip"
    """
    if not user_info:
        return "new"
    
    if visits_count == 0:
        return "new"
    elif visits_count < 5:
        return "regular"
    else:
        return "vip"
